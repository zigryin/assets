(()=>{"use strict";const $=(s)=>document.querySelectorAll(s),A="z",L="zl",S="script";const r=(s)=>{let n=document.createElement(S);for(let a of s.attributes)
if(a.name!==A&&a.name!==L)n.setAttribute(a.name,a.value);n.text=s.text;s.replaceWith(n);};const f=(l)=>$(S+`[${A}]${l ? "[" + L + "]" : ""}`).forEach((s)=>r(s));window.addEventListener("load",()=>{f(0);f(1)});window.ZZ={run:()=>f(0),lazy:()=>f(1)}})();if("serviceWorker" in navigator){navigator.serviceWorker.register("/sw.js").then(()=>console.log("SW ready"))}
document.addEventListener("DOMContentLoaded",()=>{let lastVisibleUrl=window.location.href;let alertOpen=!1;let queue=[];const zigry={hooks:{beforeMount:[],afterMount:[],beforeNavigate:[],afterNavigate:[],onFormSubmit:[],onAssetsLoaded:[],},use(name,callback){if(!zigry.hooks[name])zigry.hooks[name]=[];zigry.hooks[name].push(callback)},runHooks(name,payload){(zigry.hooks[name]||[]).forEach((fn)=>fn(payload))},mount(html,props={}){const app=document.getElementById("zigry-app");let root;if(html){root=document.createElement("div");root.innerHTML=html}else{root=app||document}
for(let[k,v]of Object.entries(props)){root.querySelectorAll(`[data-prop="${k}"]`).forEach((el)=>{el.textContent=v})}
if(html&&app){app.innerHTML="";app.appendChild(root)}(async()=>{const scripts=Array.from(root.querySelectorAll("script"));for(const oldScript of scripts){const src=oldScript.src||null;const type=oldScript.type||null;oldScript.remove();if(src){await new Promise((resolve)=>{const s=document.createElement("script");if(type)s.type=type;s.src=src+(src.includes("?")?"&":"?")+"v="+Date.now();s.async=!1;s.onload=resolve;s.onerror=resolve;document.body.appendChild(s)});continue}
const code=oldScript.textContent.trim();if(!code)continue;if(code.includes("DOMContentLoaded")){try{const startIndex=code.indexOf("{")+1;let depth=1;let endIndex=startIndex;while(endIndex<code.length&&depth>0){const ch=code[endIndex++];if(ch==="{")depth++;if(ch==="}")depth--}
const body=code.slice(startIndex,endIndex-1).trim();new Function(body)()}catch(err){console.warn("Inline DOMReady exec failed",err)}}else{new Function(code)()}}
try{zigry.bindForms()}catch(e){}})()},navigate(href){zigry.runHooks("beforeNavigate",{href});const target=new URL(href,location.href);const current=new URL(location.href);if(target.hash&&target.pathname===current.pathname&&target.search===current.search&&target.hash!==current.hash){history.pushState({},"",target.href);return}
history.pushState({},"",target.href);zigry.load(target.href);zigry.runHooks("afterNavigate",{href})},load(href){const currentReferrer=lastVisibleUrl;lastVisibleUrl=href;zigry.loader(!0);zigry.prefetchUserLocation();const geo=window.zigryGeo??{};fetch(href,{headers:{"X-Requested-With":"Zigry-Ajax",location:encodeURIComponent(JSON.stringify(geo)),"X-Referer":currentReferrer,},}).then((r)=>{if(r.redirected){zigry.navigate(r.url);zigry.loader(!1);return}
return r.json()}).then((p)=>{currentPage=0;hasMore=!0;if(p.html)zigry.mount(p.html,p.props);if(p.title)zigry.updateHead(p.title,p.meta);zigry.updateCanonical(p.canonical??window.location.href);zigry.setActiveLink(href);if(p.assets)zigry.loadAssets(p.assets);if(p?.alert)
zalert(p.alert,p.type??"error",p.position??"top-right");setupObserver();zigry.loader(!1);if(p.redirect!==null&&p.redirect!==undefined){setTimeout(()=>zigry.reload(p.redirect),500)}
zvalid();initApp();zScroll();initEmoji();reverse_counter();initTabs()}).catch(()=>{window.location.href=href;zigry.loader(!1);zigry.offline();zigry.updateHead("Offline");initApp()});document.querySelectorAll(".encrypted").forEach(decryptAndSetProtectedMedia);initApp()},offline(){return caches.match("/offline")},reload(url){window.location.replace(url)},bindForms(){const generateVideoThumbnail=(file)=>{return new Promise((resolve)=>{if(!file.type.startsWith("video/")){return resolve(null)}
const video=document.createElement("video");video.preload="metadata";video.src=URL.createObjectURL(file);video.muted=!0;video.playsInline=!0;video.onloadeddata=()=>{video.currentTime=1};video.onseeked=()=>{const canvas=document.createElement("canvas");canvas.width=video.videoWidth;canvas.height=video.videoHeight;const ctx=canvas.getContext("2d");ctx.drawImage(video,0,0,canvas.width,canvas.height);URL.revokeObjectURL(video.src);canvas.toBlob((blob)=>{resolve(new File([blob],"thumbnail.jpg",{type:"image/jpeg"}))},"image/jpeg",0.8)}})};document.querySelectorAll("form[zigry-form]").forEach((f)=>{f.addEventListener("submit",async(e)=>{e.preventDefault();const csrfInput=document.querySelector('input[name="_token"]');const csrfMeta=document.querySelector('meta[name="csrf-token"]');const csrf=csrfInput?.value??csrfMeta?.content??"";const d=new FormData(f);zigry.loader(!0);const videoInput=f.querySelector('input[type="file"][accept^="video/"]');if(videoInput&&videoInput.files[0]){const thumbnailFile=await generateVideoThumbnail(videoInput.files[0]);if(thumbnailFile){d.append("video_thumbnail",thumbnailFile)}}
const geo=window.zigryGeo;let method=f.method||"POST";const hiddenMethod=f.querySelector('input[name="_method"]');if(hiddenMethod){method=hiddenMethod.value}
fetch(f.action||location.href,{method:method,credentials:"include",headers:{"X-Requested-With":"Zigry-Ajax","X-CSRF-Token":csrf,location:encodeURIComponent(JSON.stringify(geo)),},body:d,}).then((r)=>{if(r.redirected){zigry.navigate(r.url);zigry.loader(!1);return}
return r.json()}).then((p)=>{if(p?.toast)zigry.toast(p.toast,p.type??"");if(p?.alert)
zalert(p.alert,p.type??"error",p.position??"top-right");if(p?.notify)zigry.notify(p.notify,p.type??"");if(p?.html||p?.props)zigry.mount(p.html,p.props||{});if(p?.title)zigry.updateHead(p.title,p.meta||{});zigry.loader(!1);zigry.runHooks("afterFormSubmit",p);if(p.redirect!==null&&p.redirect!==undefined){setTimeout(()=>zigry.reload(p.redirect),500)}}).catch((e)=>{console.warn(e);zalert(e,"error","center",0,[{label:"Ok",class:"btn-danger"},]);zigry.loader(!1)})})})},async prefetchUserLocation(){const getCanonicalTimezone=(tz)=>tz==="Asia/Calcutta"?"Asia/Kolkata":tz;const CACHE_KEY="zigry-ip-location";const CACHE_TTL=60*60*1000;let usedCache=!1;async function getIpLocationFallback(){const cached=localStorage.getItem(CACHE_KEY);if(cached){const{data,timestamp}=JSON.parse(cached);if(Date.now()-timestamp<CACHE_TTL){usedCache=!0;return data}}
const sources=[async()=>{const res=await fetch("//ipapi.co/json");const json=await res.json();if(json.ip&&json.latitude&&json.longitude&&json.city&&json.region&&json.country_name){return{country:json.country_name,countryCode:json.country,region:json.region_code||json.region,regionName:json.region,city:json.city,latitude:parseFloat(json.latitude),longitude:parseFloat(json.longitude),timezone:getCanonicalTimezone(json.timezone),isp:json.org||"",ip:json.ip,accuracy:50000,}}},async()=>{const res=await fetch("//ipwho.is");const json=await res.json();if(json.success&&json.ip&&json.latitude&&json.longitude){return{country:json.country,countryCode:json.country_code,region:json.region,regionName:json.region,city:json.city,latitude:json.latitude,longitude:json.longitude,timezone:getCanonicalTimezone(json.timezone?.id||""),isp:json.connection?.isp||"",ip:json.ip,accuracy:50000,}}},async()=>{const res=await fetch("//freeipapi.com/api/json");const json=await res.json();if(json.IPv4&&json.latitude&&json.longitude){return{country:json.countryName,countryCode:json.countryCode,region:json.regionName,regionName:json.regionName,city:json.cityName,latitude:parseFloat(json.latitude),longitude:parseFloat(json.longitude),timezone:getCanonicalTimezone(json.time_zone||""),isp:json.isp||"",ip:json.IPv4,accuracy:50000,}}},];for(const trySource of sources){try{const data=await trySource();if(data?.latitude&&data?.longitude){localStorage.setItem(CACHE_KEY,JSON.stringify({data,timestamp:Date.now()}));return data}}catch(e){console.warn("IP fallback source failed:",e.message)}}
return null}
const ipData=await getIpLocationFallback();const timezone=getCanonicalTimezone(Intl.DateTimeFormat().resolvedOptions().timeZone);let geoData={...ipData,timezone,};try{document.addEventListener("click",async()=>{const position=await new Promise((resolve,reject)=>navigator.geolocation.getCurrentPosition(resolve,reject,{enableHighAccuracy:!0,timeout:5000,maximumAge:60000,}));const{latitude,longitude,accuracy}=position.coords;geoData.latitude=latitude;geoData.longitude=longitude;geoData.accuracy=accuracy;geoData.source="gps"})}catch(e){console.warn("Geolocation failed:",e.message);geoData.source="ip"}
localStorage.setItem(CACHE_KEY,JSON.stringify({data:geoData,timestamp:Date.now()}));window.zigryGeo=geoData},updateCanonical(url=window.location.href){let tag=document.querySelector('link[rel="canonical"]');if(!tag){tag=document.createElement("link");tag.rel="canonical";document.head.appendChild(tag)}
tag.href=url},updateHead(title,meta={},separator=" - "){const titleElement=document.querySelector("title");if(!titleElement.dataset.baseTitle){const sepRegex=/\s[-|>]{1,2}\s/;const parts=document.title.split(sepRegex);titleElement.dataset.baseTitle=parts[0].trim()}
const baseTitle=titleElement.dataset.baseTitle;document.title=title?`${baseTitle}${separator}${title}`:baseTitle;Object.entries(meta).forEach(([key,content])=>{let attribute="name";if(key.startsWith("og:")){attribute="property"}else if(key.startsWith("twitter:")){attribute="name"}
let tag=document.querySelector(`meta[${attribute}="${key}"]`);if(!tag){tag=document.createElement("meta");tag.setAttribute(attribute,key);document.head.appendChild(tag)}
tag.setAttribute("content",content)})},toast(msg,type="success"){const box=document.getElementById("zigry-toast");const t=document.createElement("div");t.className=`toast align-items-center text-white bg-${type} border-0 show mb-2 p-2`;t.textContent=msg;box.appendChild(t);setTimeout(()=>t.remove(),3000)},notify(notify=null,type="success"){for(let[k,v]of Object.entries(notify)){const input=document.querySelector(`[name="${k}"]`);let errorMessageElement=document.createElement("div");errorMessageElement.className=`notify-wrapper w-100 text-left mt-1 ${
          type === "danger" ? "text-warning" : "text-success"
        }`;errorMessageElement.style.position="absolute";errorMessageElement.style.top=`${
          input.offsetTop + input.offsetHeight
        }px`;errorMessageElement.style.left=`0`;errorMessageElement.style.zIndex="1000";errorMessageElement.innerHTML=`<div class="notify-text small p-1 opacity-50">${v}</div>`;input.parentNode.appendChild(errorMessageElement);setTimeout(()=>errorMessageElement.remove(),10000)}},alert({title,message,type=null,position="center",buttons=[],duration=3000,multiple=!1,anchor=null,width=360,height=null,}){return new Promise((resolve)=>{if(typeof alertOpen==="undefined")window.alertOpen=!1;if(typeof queue==="undefined")window.queue=[];if(alertOpen&&!multiple){queue.push(()=>zigry.alert({title,message,type,buttons,duration,multiple,anchor,width,height,position,}).then(resolve));return}
alertOpen=!0;const isDark=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;const bgColor=isDark?"#2b2b2b":"#ffffff";const textColor=isDark?"#ffffff":"#333333";const borderColor=isDark?"rgba(255,255,255,0.06)":"rgba(0,0,0,0.06)";const overlayColor=isDark?"rgba(255,255,255,0.04)":"rgba(0,0,0,0.12)";let zone=document.getElementById("toastZone");if(!zone){zone=document.createElement("div");zone.id="toastZone";document.body.appendChild(zone)}
Object.assign(zone.style,{display:"flex",alignItems:position.includes("top")?"flex-start":position.includes("bottom")?"flex-end":"center",justifyContent:position.includes("left")?"flex-start":position.includes("right")?"flex-end":"center",pointerEvents:"auto",position:"fixed",top:"0",left:"0",width:"100vw",height:"100vh",zIndex:"9999",background:overlayColor,padding:"1rem",});const icons={success:`<div class="zigry-icon zigry-success"><div class="zigry-success-line-tip"></div><div class="zigry-success-line-long"></div></div>`,error:`<div class="zigry-icon zigry-error"><div class="zigry-error-line zigry-error-left"></div><div class="zigry-error-line zigry-error-right"></div></div>`,danger:`<div class="zigry-icon zigry-error"><div class="zigry-error-line zigry-error-left"></div><div class="zigry-error-line zigry-error-right"></div></div>`,warning:`<div class="zigry-icon zigry-warning">!</div>`,info:`<div class="zigry-icon zigry-info"><span>i</span></div>`,question:`<div class="zigry-icon zigry-question"><span>?</span></div>`,};const toast=document.createElement("div");toast.className="zigry-toast zigry-liquid";toast.style.minWidth=typeof width==="number"?width+"px":width;toast.style.width=typeof width==="number"?width+"px":width;if(height)
toast.style.maxHeight=typeof height==="number"?height+"px":height;toast.tabIndex=-1;toast.style.setProperty("--zigry-bg",bgColor);toast.style.setProperty("--zigry-color",textColor);toast.style.setProperty("--zigry-border-color",borderColor);const iconHtml=type&&icons[type]?icons[type]:"";toast.innerHTML=`
                  <div class="zigry-body">
                    ${iconHtml}
                    <div class="zigry-text">
                      <div class="zigry-title">${title || ""}</div>
                      <div class="zigry-message">${message || ""}</div>
                    </div>
                  </div>
              `;let settled=!1;if(buttons&&buttons.length){const footer=document.createElement("div");footer.className="zigry-toastfooter";buttons.forEach((btn,idx)=>{const b=document.createElement("button");b.className=`btn btn-sm ${btn.class || "btn-primary"}`;b.textContent=btn.label||"Button "+(idx+1);b.onclick=()=>{if(settled)return;settled=!0;toast.remove();zone.style.display="none";alertOpen=!1;const retVal=btn.value!==undefined?btn.value:idx===0?!0:!1;resolve(retVal);if(queue.length)queue.shift()();if(typeof btn.onClick==="function")setTimeout(btn.onClick,0);};footer.appendChild(b)});toast.appendChild(footer)}
zone.appendChild(toast);if(anchor){let rect;if(anchor instanceof HTMLElement)
rect=anchor.getBoundingClientRect();else if(anchor&&anchor.clientX!==undefined)
rect={left:anchor.clientX,top:anchor.clientY,width:0,height:0,};if(rect){toast.style.position="absolute";toast.style.top=rect.top+rect.height+12+window.scrollY+"px";toast.style.left=rect.left+rect.width/2+window.scrollX+"px";toast.style.transform="translate(-50%,0)"}}
if(duration&&(!buttons||!buttons.length)){setTimeout(()=>{if(!settled){settled=!0;toast.remove();zone.style.display="none";alertOpen=!1;resolve();if(queue.length)queue.shift()();}},duration)}})},async confirm(message=null,title=null,type="info"){return await zigry.alert({title:title??"Confirm?",message:message??"Are you sure?",type:type,duration:0,buttons:[{label:"Yes",class:"btn-danger",value:!0,},{label:"Cancel",class:"btn-secondary",value:!1,},],}).then((result)=>{return result})},loader(show){const el=document.getElementById("zigry-loader");if(!el)return;if(show){el.classList.remove("d-none","fade");void el.offsetWidth;el.classList.add("show")}else{el.classList.remove("show");el.classList.add("fade");setTimeout(()=>{el.classList.add("d-none")},150)}},setActiveLink(href){document.querySelectorAll(".zigry-link").forEach((link)=>{const linkHref=link.getAttribute("href");if(linkHref===href||location.pathname===linkHref){link.classList.add("active")}else{link.classList.remove("active")}})},loadAssets(assets={}){const loaded=new Set([...document.querySelectorAll('link[rel="stylesheet"], script[src]'),].map((el)=>el.href||el.src));if(Array.isArray(assets)){assets.forEach((url)=>this._injectAsset(url,loaded))}else{Object.values(assets).flat().forEach((url)=>this._injectAsset(url,loaded))}},_injectAsset(url,loadedSet){if(loadedSet.has(url))return;if(url.endsWith(".css")){const link=document.createElement("link");link.rel="stylesheet";link.href=url;document.head.appendChild(link)}else if(url.endsWith(".js")){const script=document.createElement("script");script.src=url;script.defer=!0;document.body.appendChild(script)}},async share(data,inputFiles){currentUrl=window.location.href;const fileItems=Array.isArray(inputFiles)?inputFiles:[inputFiles];let processedFiles=[];for(const item of fileItems){try{let blob,filename,type;if(typeof item==="string"){const response=await fetch(item);blob=await response.blob();type=blob.type;filename=item.substring(item.lastIndexOf("/")+1);if(!filename.includes(".")){const ext=type.split("/")[1]||"dat";filename+="."+ext}}else if(item instanceof Blob&&!(item instanceof File)){blob=item;type=blob.type||"application/octet-stream";const ext=type.split("/")[1]||"dat";filename="file_"+Date.now()+"."+ext}else if(item instanceof File){processedFiles.push(item);continue}else{console.warn("Unsupported file type:",item);continue}
processedFiles.push(new File([blob],filename,{type}))}catch(e){console.error(`Failed to process file:`,item,e)}}
const shareData={title:`Zigry.in`,text:data||"",files:processedFiles,};if(navigator.canShare&&!navigator.canShare(shareData)){zalert("Your browser does not support sharing these files together.","warning");return}
if(navigator.share){try{await navigator.share(shareData)}catch(error){if(error.name!=="AbortError"){const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);if(isMobile){zalert("Sharing failed. Please try your browser's share feature or copy the link manually.","warning")}else{zalert("Sharing not fully supported in this browser. Try copying the link manually.","warning")}}}}else{try{if(navigator.clipboard?.writeText){await navigator.clipboard.writeText(currentUrl);zalert("Link copied to clipboard!","info")}else{zalert("Sharing not supported. Copy link manually: "+currentUrl,"error","center",0)}}catch{zalert("Sharing not supported. Copy link manually: "+currentUrl,"error","center",0)}}},};window.zigry=zigry;zigry.setActiveLink(location.href);document.body.addEventListener("click",async(e)=>{const a=e.target.closest(".zigry-link");const za=a?.getAttribute("href");const href=e.target.closest("a[href]");if(a){e.preventDefault();if(za&&za.startsWith("#")){history.pushState({},"",za);const el=document.getElementById(za.slice(1));if(el){el.scrollIntoView({behavior:"smooth",block:"start"})}
return}else{zigry.navigate(za);setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"})},100);zScroll()}
return}else if(href){const hrefVal=href.getAttribute("href");history.pushState({},"",hrefVal);const hash=new URL(hrefVal,location.href).hash;if(hrefVal.startsWith("#")){e.preventDefault();const el=document.getElementById(hash.slice(1));if(el)el.scrollIntoView({behavior:"smooth"})}else{window.scrollTo({top:0,behavior:"smooth"})}}
const btn=e.target.closest("[data-action]");if(!btn)return;const card=btn.closest("[data-post-id]");if(!card)return;const postId=card.dataset.postId;const action=btn.dataset.action;if(action==="like"){likePost(postId,card,btn)}else if(action==="comment"){await commentPost(postId,card,btn)}else if(action==="share"){await sharePost(postId,card,btn)}else if(action==="edit"){editPost(postId,card)}else if(action==="delete"){deletePost(postId,card)}else if(action==="report"){reportPost(postId,card)}});async function likePost(postId,card,button){try{const res=await fetch(`/api/post/${postId}/like`,{method:"POST"});const result=await res.json();if(result.success){const likeText=button.querySelector(".like-text");const likeIcon=button.querySelector(".like-icon");likeIcon.textContent=result.like_icon;likeText.textContent=result.like_text;const countEl=card.querySelector(".like_count");if(countEl){countEl.textContent=result.like_count}}else{if(result.redirect!==null&&result.redirect!==undefined){setTimeout(()=>zigry.reload(result.redirect),500)}else{zigry.toast(result.message||"Failed to like","danger")}}}catch(err){zigry.alert({title:"Error",message:"Server error!",type:"danger",duration:0,buttons:[{label:"Ok",class:"btn-danger"}],})}}
async function commentPost(postId,card,button){let commentsSection=card.querySelector(".comments-section");if(!commentsSection){commentsSection=document.createElement("div");commentsSection.className="comments-section px-3 py-2 border-top";commentsSection.innerHTML=`
        <div class="comments-container mb-2" style="max-height: 300px; overflow-y: auto;"></div>
        <div class="comment-input-group d-flex gap-2">
          <input type="text" class="form-control form-control-sm comment-input" placeholder="Write a comment..." data-post-id="${postId}">
          <button class="btn btn-sm btn-primary comment-submit-btn" data-post-id="${postId}">Post</button>
        </div>
      `;const cardFooter=card.querySelector(".card-footer");if(cardFooter){cardFooter.parentNode.insertBefore(commentsSection,cardFooter.nextSibling)}
await loadComments(postId,commentsSection.querySelector(".comments-container"));const submitBtn=commentsSection.querySelector(".comment-submit-btn");const commentInput=commentsSection.querySelector(".comment-input");const handleCommentSubmit=async()=>{const content=commentInput.value.trim();if(!content){zigry.toast("Please enter a comment","info");return}
try{const csrf=document.querySelector('meta[name="csrf-token"]')?.content||"";const formData=new FormData();formData.append("content",content);const res=await fetch(`/api/posts/${postId}/comment`,{method:"POST",headers:{"X-CSRF-TOKEN":csrf,},body:formData,});const result=await res.json();if(result.success){commentInput.value="";const countEl=card.querySelector(".comments_count");if(countEl){countEl.textContent=result.comment_count||0}
await loadComments(postId,commentsSection.querySelector(".comments-container"));zigry.toast("Comment added successfully!","success")}else{if(result.redirect!==null&&result.redirect!==undefined){setTimeout(()=>zigry.reload(result.redirect),500)}else{zigry.toast(result.message||"Failed to add comment","danger")}}}catch(err){zigry.toast("Server error!","danger")}};submitBtn.addEventListener("click",handleCommentSubmit);commentInput.addEventListener("keypress",(e)=>{if(e.key==="Enter"){handleCommentSubmit()}})}else{commentsSection.style.display=commentsSection.style.display==="none"?"block":"none"}}
async function loadComments(postId,container){if(!container)return;try{const res=await fetch(`/api/posts/${postId}/comments`);const result=await res.json();if(result.success&&result.html){container.innerHTML=result.html||'<div class="text-muted small p-2">No comments yet</div>'}}catch(err){console.error("Failed to load comments:",err)}}
async function sharePost(postId,card,button){try{const csrf=document.querySelector('meta[name="csrf-token"]')?.content||"";const res=await fetch(`/api/posts/${postId}/share`,{method:"POST",headers:{"X-CSRF-TOKEN":csrf,},});const result=await res.json();if(result.success){const countEl=card.querySelector(".share_count");if(countEl){countEl.textContent=result.share_count||0}
zigry.toast(result.message||"Post shared successfully!","success")}else{if(result.redirect!==null&&result.redirect!==undefined){setTimeout(()=>zigry.reload(result.redirect),500)}else{zigry.toast(result.message||"Failed to share post","danger")}}}catch(err){zigry.toast("Server error!","danger")}}
async function editPost(postId,card){try{const contentEl=card.querySelector(".content");const currentContent=contentEl?contentEl.innerHTML:"";const privacy=card?.dataset?.privacy||"public";if(typeof window.openEditComposer==="function"){window.openEditComposer(postId,currentContent,privacy);return}
const newContent=prompt("Edit your post:",currentContent.replace(/<[^>]*>/g,""));if(newContent===null)return;const formData=new FormData();formData.append("content",newContent);formData.append("_method","PUT");const res=await fetch(`/api/posts/${postId}/edit`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,},body:formData,});const data=await res.json();if(data.success){zigry.toast(data.message,"success");if(contentEl)contentEl.innerHTML=newContent}else{zigry.toast(data.message||"Failed to edit post","error")}}catch(err){console.error(err);zigry.toast("Something went wrong","error")}}
async function deletePost(postId,card){const confirmed=await zigry.confirm("Are you sure you want to delete this post?","Delete Post","warning");if(!confirmed)return;try{const res=await fetch(`/api/posts/${postId}/delete`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,},});const data=await res.json();if(data.success){zigry.toast(data.message,"success");card.remove()}else{zigry.toast(data.message||"Failed to delete post","error")}}catch(err){console.error(err);zigry.toast("Something went wrong","error")}}
async function reportPost(postId,card){const reason=await zigry.alert({title:"Report Post",message:"Why are you reporting this post?",type:"warning",duration:0,buttons:[{label:"Spam",class:"btn-warning",value:"spam"},{label:"Inappropriate",class:"btn-danger",value:"inappropriate"},{label:"Harassment",class:"btn-danger",value:"harassment"},{label:"Other",class:"btn-secondary",value:"other"},{label:"Cancel",class:"btn-outline-secondary",value:!1},],});if(!reason)return;try{const formData=new FormData();formData.append("reason",reason);const res=await fetch(`/api/posts/${postId}/report`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,},body:formData,});const data=await res.json();if(data.success){zigry.toast(data.message,"success")}else{zigry.toast(data.message||"Failed to report post","error")}}catch(err){console.error(err);zigry.toast("Something went wrong","error")}}
window.addEventListener("popstate",()=>{zigry.load(location.href);lastVisibleUrl=window.location.href});window.addEventListener("online",()=>checkOnline(location.pathname));window.addEventListener("offline",(event)=>checkOffline(event));window.addEventListener("beforeunload",()=>{});zigry.bindForms();currentPage=0;hasMore=!0;setupObserver();zigry.prefetchUserLocation()});function checkOnline(path){if(localStorage.getItem("offline")){zigry.navigate(path);zigry.toast("‚úÖ Back online","gray text-center position-fixed bottom-0 start-50 translate-middle-x p-3");localStorage.removeItem("offline")}}
function checkOffline(event){zigry.loader(!1);zigry.toast("‚ùå Internet connection not availble","gray text-center position-fixed bottom-0 start-50 translate-middle-x p-3");localStorage.setItem("offline",!0)}
function showToast(title,message,onConfirm=null,args=[],resultType="success",showWarningIcon=!1){const zone=document.getElementById("toastZone");const isDark=window.matchMedia("(prefers-color-scheme: dark)").matches;const icons={success:`<svg class="toast-icon" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#28a745"/><path d="M7 13l3 3 7-7" stroke="white" stroke-width="2"/></svg>`,error:`<svg class="toast-icon" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#dc3545"/><path d="M15 9l-6 6M9 9l6 6" stroke="white" stroke-width="2"/></svg>`,warning:`<svg class="toast-icon" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#ffc107"/><path d="M12 7v5m0 4h.01" stroke="black" stroke-width="2"/></svg>`,};const toast=document.createElement("div");toast.className=`toast show text-bg-${
    isDark ? "dark" : "light"
  } border-0 mb-2`;toast.innerHTML=`
      <div class="toast-header">
        <strong class="me-auto">${title}</strong>
      </div>
      <div class="toast-body">
        ${
          showWarningIcon
            ? `<div class="text-center mb-2">${icons.warning}</div>`
            : ""
        }
        ${message}
      </div>
      <div class="d-flex justify-content-end gap-2 px-3 pb-2">
        <button class="btn btn-sm btn-secondary">Cancel</button>
        <button class="btn btn-sm btn-danger">Confirm</button>
      </div>
    `;const[cancelBtn,confirmBtn]=toast.querySelectorAll("button");cancelBtn.onclick=()=>toast.remove();confirmBtn.onclick=()=>{if(typeof onConfirm==="function")onConfirm(...args);toast.querySelector(".toast-body").innerHTML=`
        <div class="text-center">
          ${icons[resultType]}
          <div class="mt-2">${
            resultType === "success"
              ? "Success!"
              : resultType === "error"
              ? "Failed!"
              : "Warning!"
          }</div>
        </div>
      `;toast.querySelector(".toast-header strong").textContent=resultType[0].toUpperCase()+resultType.slice(1);toast.querySelector(".d-flex").remove();setTimeout(()=>toast.remove(),2000)};zone.appendChild(toast)}
function zalert(message,type="info",position="center",duration=3000,buttons=!1){zigry.alert({title:type.charAt(0).toUpperCase()+type.slice(1),message:message,type:type,duration:duration,position:position,buttons:buttons,})}
function zdelete(message="Delete this file?"){zigry.alert({title:"Confirm?",message:message,type:"warning",duration:0,buttons:[{label:"Yes",class:"btn-danger",onClick:()=>zigry.alert({title:"Alert",message:"Deleted successfully!",type:"info",}),},{label:"Cancel",class:"btn-secondary"},],})}
document.addEventListener("DOMContentLoaded",()=>{let currentIndex=0;let scale=1;let lastTouchDistance=null;let isDragging=!1;let dragStartX=0;function toggleFullscreen(enter){if(!document.fullscreenEnabled)return;const el=document.documentElement;if(enter){if(!document.fullscreenElement){el.requestFullscreen?.()}}else{if(document.fullscreenElement){document.exitFullscreen?.()}}}
async function openZigryLightbox(index,elements){elements||=[...document.querySelectorAll(".zigry-images img, .zigry-video video"),];if(!elements.length||!elements[index])return;let current=index,scale=1,dragging=!1;const lightbox=Object.assign(document.createElement("div"),{id:"zigryLightbox",className:"zigry-lightbox",});document.body.append(lightbox);document.body.style.overflow="hidden";let media=createMedia(elements[current]);lightbox.append(media);loadMedia(media,elements[current]);const prevBtn=makeBtn("‚ü®","prev",()=>current>0&&switchMedia(current-1));const nextBtn=makeBtn("‚ü©","next",()=>current<elements.length-1&&switchMedia(current+1));const closeBtn=Object.assign(document.createElement("button"),{type:"button",className:"btn-close position-absolute top-0 end-0 m-3",onclick:closeLightbox,});lightbox.append(prevBtn,nextBtn,closeBtn);updateNav();document.addEventListener("keydown",(e)=>{if(e.key==="Escape")closeLightbox();if(e.key==="ArrowLeft")prevBtn.click();if(e.key==="ArrowRight")nextBtn.click();});lightbox.onclick=(e)=>e.target===lightbox&&!dragging&&closeLightbox();function createMedia(el){const v=el.tagName==="VIDEO";const m=document.createElement(v?"video":"img");Object.assign(m.style,{maxWidth:"90vw",maxHeight:"90vh",transition:"transform .4s ease, opacity .4s ease",position:"absolute",left:"50%",top:"50%",transform:"translate(-50%,-50%)",});if(v)Object.assign(m,{controls:!0,autoplay:!0});m.draggable=!1;return m}
function loadMedia(m,el){const src=el.dataset.decryptedSrc||el.dataset.full||el.dataset.url||el.src;if(el.tagName==="VIDEO")(m.src=src),m.load();else m.src=src}
function switchMedia(newIndex){const dir=newIndex>current?1:-1;const old=media;const next=createMedia(elements[newIndex]);loadMedia(next,elements[newIndex]);next.style.transform=`translate(calc(-5% + ${dir * 250}%), -100%)`;next.style.opacity="0";next.style.position="absolute";lightbox.append(next);requestAnimationFrame(()=>{old.style.transform=`translate(calc(-5% - ${dir * 250}%), -100%)`;old.style.opacity="0";next.style.transform="translate(-50%, -50%)";next.style.opacity="1"});setTimeout(()=>{old.remove();media=next;current=newIndex;scale=1;updateNav();attachDrag();addZoomEvents()},400)}
function makeBtn(txt,cls,fn){const b=document.createElement("button");b.className=`nav-btn btn btn-light rounded-circle shadow ${cls}`;b.textContent=txt;b.onclick=fn;return b}
function updateNav(){prevBtn.style.opacity=current===0?".2":".6";nextBtn.style.opacity=current===elements.length-1?".2":".6"}
function closeLightbox(){document.body.style.overflow="";lightbox.remove()}
function attachDrag(){let startX=0,startY=0;let deltaX=0,deltaY=0;let isSwiping=!1;let direction=null;media.addEventListener("mousedown",(e)=>{if(scale!==1)return;isSwiping=!0;startX=e.clientX;startY=e.clientY;direction=null;deltaX=deltaY=0;media.style.transition="none"});window.addEventListener("mousemove",(e)=>{if(!isSwiping||scale!==1)return;deltaX=e.clientX-startX;deltaY=e.clientY-startY;if(!direction&&Math.abs(deltaY)>20)direction="vertical";if(!direction&&Math.abs(deltaX)>20)direction="horizontal";if(direction==="horizontal"){media.style.transform=`translate(calc(-50% + ${deltaX}px), -50%) scale(${scale})`}else if(direction==="vertical"){media.style.transform=`translate(-50%, calc(-50% + ${deltaY}px)) scale(${scale})`;media.style.opacity=`${1 - Math.min(Math.abs(deltaY) / 300, 0.7)}`}});window.addEventListener("mouseup",(e)=>{if(!isSwiping)return;isSwiping=!1;media.style.transition="transform .25s ease, opacity .25s ease";if(direction==="horizontal"&&Math.abs(deltaX)>80){if(deltaX>0&&current>0)switchMedia(current-1);else if(deltaX<0&&current<elements.length-1)
switchMedia(current+1);else reset()}else if(direction==="vertical"&&deltaY<-100){closeLightbox()}else{reset()}});media.addEventListener("touchstart",(e)=>{if(e.touches.length===1&&scale===1){isSwiping=!0;startX=e.touches[0].clientX;startY=e.touches[0].clientY;direction=null;deltaX=deltaY=0;media.style.transition="none"}});media.addEventListener("touchmove",(e)=>{if(!isSwiping||scale!==1)return;deltaX=e.touches[0].clientX-startX;deltaY=e.touches[0].clientY-startY;if(!direction&&Math.abs(deltaY)>40)direction="vertical";if(!direction&&Math.abs(deltaX)>10)direction="horizontal";if(direction==="horizontal"){media.style.transform=`translate(calc(-50% + ${deltaX}px), -50%) scale(${scale})`}else if(direction==="vertical"){media.style.transform=`translate(-50%, calc(-50% + ${deltaY}px)) scale(${scale})`;media.style.opacity=`${
              1 - Math.min(Math.abs(deltaY) / 300, 0.7)
            }`}},{passive:!0});media.addEventListener("touchend",()=>{if(!isSwiping)return;isSwiping=!1;media.style.transition="transform .25s ease, opacity .25s ease";if(direction==="horizontal"&&Math.abs(deltaX)>50){if(deltaX>0&&current>0)switchMedia(current-1);else if(deltaX<0&&current<elements.length-1)
switchMedia(current+1);else reset()}else if(direction==="vertical"&&deltaY<-100){closeLightbox()}else{reset()}});function reset(){media.style.transform=`translate(-50%, -50%) scale(${scale})`;media.style.opacity="1"}}
function addZoomEvents(){let lastTap=0;media.addEventListener("touchstart",(e)=>{if(e.touches.length===1){const now=Date.now();if(now-lastTap<300){e.preventDefault();const r=media.getBoundingClientRect();const ox=((e.touches[0].clientX-r.left)/r.width)*100;const oy=((e.touches[0].clientY-r.top)/r.height)*100;if(scale===1){scale=2;media.style.transformOrigin=`${ox}% ${oy}%`}else{scale=1;media.style.transformOrigin="center center"}
media.style.transform=`translate(-50%, -50%) scale(${scale})`;lastTap=0}else{lastTap=now}}});media.onwheel=(e)=>{e.preventDefault();const r=media.getBoundingClientRect();const ox=((e.clientX-r.left)/r.width)*100;const oy=((e.clientY-r.top)/r.height)*100;const prev=scale;scale=e.deltaY<0?Math.min(scale*1.1,3):Math.max(scale/1.1,1);media.style.transformOrigin=`${ox}% ${oy}%`;media.style.transform=`translate(-50%, -50%) scale(${scale})`};let pinchDist=0,pinchStart=scale;media.ontouchstart=(e)=>{if(e.touches.length===2){const[a,b]=e.touches;pinchDist=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);pinchStart=scale}};media.ontouchmove=(e)=>{if(e.touches.length===2){e.preventDefault();const[a,b]=e.touches;const newDist=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);const factor=newDist/pinchDist;scale=Math.min(Math.max(pinchStart*factor,1),3);const cx=(a.clientX+b.clientX)/2;const cy=(a.clientY+b.clientY)/2;const r=media.getBoundingClientRect();const ox=((cx-r.left)/r.width)*100;const oy=((cy-r.top)/r.height)*100;media.style.transformOrigin=`${ox}% ${oy}%`;media.style.transform=`translate(-50%, -50%) scale(${scale})`}};media.ontouchend=(e)=>{if(e.touches.length===0&&scale<=1.01){scale=1;media.style.transform=`translate(-50%, -50%) scale(1)`}};let isPanning=!1;let panStartX=0,panStartY=0;let currentX=0,currentY=0;media.addEventListener("touchstart",(e)=>{if(e.touches.length===1&&scale>1){isPanning=!0;panStartX=e.touches[0].clientX-currentX;panStartY=e.touches[0].clientY-currentY;media.style.transition="none"}},{passive:!0});media.addEventListener("touchmove",(e)=>{if(!isPanning||e.touches.length!==1||scale<=1)return;e.preventDefault();currentX=e.touches[0].clientX-panStartX;currentY=e.touches[0].clientY-panStartY;media.style.transform=`translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px)) scale(${scale})`},{passive:!1});media.addEventListener("touchend",()=>{isPanning=!1;if(scale<=1.01){currentX=currentY=0;media.style.transform=`translate(-50%, -50%) scale(1)`}})}
attachDrag();addZoomEvents()}
window.openZigryLightbox=openZigryLightbox});function bindZigryLightbox(){document.querySelectorAll(".encrypted").forEach(decryptAndSetProtectedMedia);document.querySelectorAll(".zigry-images").forEach((groupEl)=>{const imgs=groupEl.querySelectorAll("img");imgs.forEach((img,i)=>{img.style.cursor="pointer";img.removeEventListener("click",img._zigryHandler);img._zigryHandler=()=>openZigryLightbox(i,imgs);img.addEventListener("click",img._zigryHandler)})})}
function openZigryReel(index,videos){let currentIndex=index;const container=document.createElement("div");container.className="zigry-reels-container";const createVideo=(src,autoplay=!0)=>{const vid=document.createElement("video");vid.src=src;vid.autoplay=autoplay;vid.loop=!0;vid.muted=!0;vid.playsInline=!0;vid.controls=!1;vid.className="reel-video";return vid};const showVideo=(i)=>{if(!videos[i])return;container.innerHTML="";const vidEl=createVideo(videos[i].dataset.decryptedSrc||videos[i].dataset.url||videos[i].src);container.appendChild(vidEl);currentIndex=i;const next=videos[i+1];if(next){const preload=document.createElement("video");preload.src=next.dataset.decryptedSrc||next.dataset.url||next.src}};showVideo(index);let startY=0;container.addEventListener("touchstart",(e)=>(startY=e.touches[0].clientY));container.addEventListener("touchend",(e)=>{const endY=e.changedTouches[0].clientY;const delta=startY-endY;if(delta>50)showVideo(currentIndex+1);else if(delta<-50)showVideo(currentIndex-1);});container.addEventListener("wheel",(e)=>{if(e.deltaY>0)showVideo(currentIndex+1);else if(e.deltaY<0)showVideo(currentIndex-1);});const closeBtn=document.createElement("button");closeBtn.textContent="√ó";closeBtn.className="reel-close-btn";closeBtn.onclick=()=>container.remove();container.appendChild(closeBtn);document.body.appendChild(container)}
window.$=function $(el){return document.querySelector(el)};let loading=!1;let hasMore=!0;let currentPage=0;let observer=null;let translations={};const nl2br=(str)=>str.replace(/\n/g,"<br>");function renderPosts(posts,position="append"){const container=document.querySelector("#posts");if(!container)return;const fragment=document.createDocumentFragment();posts.forEach((post)=>{const privacyMap={public:"üåê",friends:"üë•",private:"üîí",};const privacyLabel=privacyMap[post.privacy?.toLowerCase()]||"‚ùì Unknown";if(post.is_ad){createAdCard(post)}
const div=document.createElement("div");let mediaHtml="";try{const mediaData=JSON.parse(post.media);if(mediaData.images){mediaData.images.forEach((img)=>{mediaHtml+=`<img class="img-fluid encrypted" data-url="${img.url}" src="${img.thumb}" />`})}
if(mediaData.videos){mediaData.videos.forEach((vid)=>{mediaHtml+=`<video class="w-100 encrypted" controls data-url="${vid.url}"></video>`})}}catch(e){mediaHtml=post.media||""}
div.innerHTML=`
      <div class="card mb-3 border-0" data-post-id="${
        post.post_id
      }" data-privacy="${post.privacy || ""}" style="min-height:100px">
      
          <div class="card-header border-0 p-1 py-0 px-1 align-items-center">
            <div class="card-title my-1">
              <div class="name d-flex justify-content-between align-items-center">
              <div class="gap-1 d-flex align-items-center">
                <a href="/${
                  post.username
                }" class="text-reset text-decoration-none zigry-link">
                  <img onerror="this.src='/assets/images/default/${
                    post.gender?.toLowerCase() || "unknown"
                  }.png'"
                       class="rounded-circle border border-2 object-fit-cover lock dp${
                         post.ref_id
                       }"
                       alt="Profile" height="40px" src="${
                         post.avatarthumb
                       }"></a>
                  <div class="my-auto">
                    <div class="d-grid">
                    <div>
                    <a href="/${
                      post.username
                    }" class="text-reset text-decoration-none zigry-link">
                    ${post.original_user_name || post.advertiser_name || ""}
                    ${
                      post.verified
                        ? '<span class="glow lock zigry-fill zigry-stroke mb-1 zigry z-verified zigry-xs"></span>'
                        : ""
                    }</a>
                    <div>
                    <span class="opacity-75 smaller">${
                      post.created_at || ""
                    }</span>
                    <span class="text-primary smaller">${privacyLabel}</span>
                    </div>
                    </div>
                    </div>
                  </div>
                </div>
                
                ${
                  post.is_ad
                    ? `<div class="float-end bg-light text-muted small p-2"><i>Ad</i></div>`
                    : `<div class="d-flex flex-column align-items-end"><div class="d-flex align-items-center gap-1"><div class="dropdown"><button class="btn btn-sm border-0 dropdown-toggle px-2 py-0" type="button" data-bs-toggle="dropdown"><span class="visually-hidden">Post Actions ${post.post_id}</span></button><ul class="dropdown-menu dropdown-menu-end p-0">${post.own_post?`
                                    <li><a class="dropdown-item" href="#" data-action="edit" data-id="${post.post_id}">Edit</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" data-action="delete" data-id="${post.post_id}">Delete</a></li>
                                  `:`
                                    <li><a class="dropdown-item text-warning" href="#" data-action="report" data-id="${post.post_id}">Report</a></li>
                                  `}</ul></div></div></div>`
                }
              </div>
            </div>
          </div>
    
          ${
            post.shared_from_name && post.shared_from_uname
              ? `<div class="p-1 py-0 mx-3 mt-1 text-muted d-flex justify-content-between align-items-center"><div class="d-flex gap-2 align-items-center">‚Ü™<b class="small d-none">${translations.Sharefrom||"Shared from"}</b><a href="/${
                        post.shared_from_uname
                      }" class="link gap-2 align-items-center d-flex zigry-link"><img onerror="this.src='/assets/images/default/${
                            post.shared_from_gender?.toLowerCase() || "unknown"
                          }.png'"
class="rounded-circle border border-2 object-fit-cover lock"
alt="Profile" height="32px" src="${
                                post.from_avatar
                              }"><div>${post.shared_from_name||""}</div><span class="${
                            post.shared_from_verified
                              ? "glow lock zigry-fill zigry-stroke mb-1 zigry z-verified zigry-xs"
                              : "d-none"
                          }"></span></a></div></div>`
              : ""
          }
        
          ${
            post.target_url
              ? '<a href="' +
                post.target_url +
                '" class="text-reset text-decoration-none">'
              : ""
          }
          <div class="card-body lead" style="min-height:50px;">
            <div class="media-files media zigry-images">${mediaHtml || ""}</div>
            <div class="content px-3 ${
              post.media && post.content ? "mt-2" : ""
            }">${nl2br(post.content || "")}</div>
          </div>
          ${post.target_url ? "</a>" : ""}
    
          <div class="card-footer p-0 border-0 mb-3">
          <div class="count d-flex justify-content-between mb-1">
            <div class="like_count w-100 mx-3 text-start smallest">${
              post.like_counts || "0"
            }</div>
            <div class="comments_count w-100 mx-3 text-center smallest">${
              post.comment_counts || "0"
            }</div>
            <div class="share_count w-100 mx-3 text-end smallest">${
              post.share_counts || "0"
            }</div>
          </div>
            <hr class="my-0">
            <div class="buttons d-flex btn-group-justified border-0 align-items-center">
              <div class="btn w-100 text-start align-items-center py-0" data-action="like"><span class="fs-5 p-0 m-0 like-icon text-danger">${
                post.likes ? "‚ô•Ô∏é" : "‚ô°"
              }</span> <span class="like-text small">${
      post.likes ? translations.unlike : translations.like
    }</span></div>
              <div class="btn w-100 text-center align-items-center py-0" data-action="comment"><span class="fs-5 p-0 m-0">‚éô</span><span class="small"> ${
                translations.comment || "Comment"
              }</span> </div>
              <div class="btn w-100 text-end  align-items-center py-0" data-action="share"><span class="fs-5 p-0 m-0">‚û§</span> <span class="small">${
                translations.share || "Share"
              }</span> </div>
            </div>
          </div>
        </div>
      `;const commentsSection=div.querySelector(".comments-section");if(commentsSection){commentsSection.style.display="none"}
const mediaContainer=div.querySelector(".media-files.media.zigry-images");if(mediaContainer){const imgs=mediaContainer.querySelectorAll("img");const imgCount=imgs.length;if(imgCount>0){mediaContainer.classList.add("zigry-gallery");if(imgCount===1){mediaContainer.classList.add("zigry-single")}else if(imgCount===2){mediaContainer.classList.add("zigry-two")}else{mediaContainer.classList.add("zigry-four")}
imgs.forEach((img,i)=>{const wrapper=document.createElement("div");wrapper.className="zigry-img-wrap d-flex justify-content-center";img.parentNode.insertBefore(wrapper,img);wrapper.appendChild(img);img.classList.add("m-1");img.classList.add("h-100");img.classList.add("object-fit-cover");if(imgCount>3&&i>2){img.classList.add("d-none");img.classList.remove("m-1")}
if(i===2&&imgCount>3){const overlay=document.createElement("div");overlay.className="zigry-overlay active";overlay.textContent=`+${imgCount - 3}`;wrapper.appendChild(overlay);overlay.addEventListener("click",(e)=>{e.stopPropagation();img.click()})}})}}
if(position==="prepend"){document.querySelector("#posts").prepend(div.firstElementChild)}else{document.querySelector("#posts").appendChild(div.firstElementChild)}
document.querySelectorAll(".encrypted").forEach(decryptAndSetProtectedMedia);initApp();zScroll();processPostLinks()})}
function createAdCard(ad){trackAd(ad.campaign_id,"impression");return `
      <div class="card mb-3 ad-card" data-campaign-id="${ad.campaign_id}">
          <div class="card-body">
              <a href="/posts/${ad.id}" onclick="trackAd(${
    ad.campaign_id
  }, 'click');" class="stretched-link"></a>
              <h6 class="card-subtitle mb-2 text-muted">${
                ad.advertiser_name
              }</h6>
              <p class="card-text">${ad.content.substring(0, 100)}...</p>
          </div>
      </div>
  `}
function trackAd(campaignId,type){navigator.sendBeacon("/api/ads/track",JSON.stringify({campaign_id:campaignId,type:type,}))}
async function loadMore(urlobj){if(loading||!hasMore)return;loading=!0;try{await zigry.prefetchUserLocation();const geo=window.zigryGeo??{};const url=urlobj.getAttribute("url")??"/";const res=await fetch(`${url + (currentPage + 1)}`,{headers:{"X-Requested-With":"Zigry-Ajax",location:encodeURIComponent(JSON.stringify(geo)),},});const json=await res.json();translations=json.translations||translations;const items=json.items||json.data||[];const pagination=json.pagination||json;if(items.length>0){currentPage=pagination.currentPage||currentPage+1;hasMore=pagination.currentPage<pagination.lastPage;renderPosts(items,"append");reconnectObserver()}else{hasMore=!1;removeObserver()}}catch(err){console.error("Failed to load more:",err)}finally{loading=!1}}
function setupObserver(){const paginate=document.querySelector(".paginate");if(!paginate||!hasMore)return;observer=new IntersectionObserver((entries)=>{const entry=entries[0];if(entry.isIntersecting&&!loading){loadMore(paginate)}},{root:null,rootMargin:"0px",threshold:1.0,});observer.observe(paginate)}
function reconnectObserver(){if(observer)observer.disconnect();requestAnimationFrame(()=>{setupObserver()})}
function removeObserver(){if(observer)observer.disconnect();observer=null}
async function decryptAndSetProtectedMedia(el){if(!el||!el.dataset.url||el.dataset.decryptedSrc||el.dataset.decryptionState==="processing")
return;el.dataset.decryptionState="processing";try{const res=await fetch(el.dataset.url);const buffer=await res.arrayBuffer();const data=new Uint8Array(buffer);const mimeLen=(data[0]<<8)+data[1];const mime=new TextDecoder().decode(data.slice(2,2+mimeLen));const offset=2+mimeLen;const key=data.slice(offset,offset+32);const iv=data.slice(offset+32,offset+48);const cipher=data.slice(offset+48);const cryptoKey=await crypto.subtle.importKey("raw",key,{name:"AES-CBC"},!1,["decrypt"]);const decrypted=await crypto.subtle.decrypt({name:"AES-CBC",iv},cryptoKey,cipher);const blob=new Blob([decrypted],{type:mime});const objectUrl=URL.createObjectURL(blob);el.dataset.decryptedSrc=objectUrl;el.dataset.full=objectUrl;if(el.tagName==="IMG"){const wrapper=document.createElement("div");wrapper.className=el.className;wrapper.id=el.id;wrapper.style.cssText=`
          display: block;
          background-image: url(${objectUrl});
          background-size: contain;
          background-size: cover;
          background-repeat: no-repeat;
          background-position: center;
          width: ${el.width || 160}px;
          height: ${el.height || 160}px;
          width: 100%;
          height: 100%;
          position: relative;
        `;const dummy=document.createElement("img");dummy.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";dummy.style.cssText="width: 100%; height: 100%; opacity: 0;";dummy.dataset.full=objectUrl;dummy.dataset.decryptedSrc=objectUrl;wrapper.appendChild(dummy);el.replaceWith(wrapper);bindZigryLightbox()}else if(el.tagName==="VIDEO"){el.poster=el.src;el.src=objectUrl;el.load();el.play().catch(()=>{})}
el.dataset.decryptionState="complete"}catch(err){console.error("[decrypt] Failed to decrypt:",err)}}["contextmenu","copy"].forEach((eventName)=>{document.addEventListener(eventName,(e)=>{if(e.target.closest(".encrypted, #zigryMedia, .zigry-lightbox, .lock"))
e.preventDefault();})});document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".encrypted").forEach(decryptAndSetProtectedMedia);initApp();const loader=document.getElementById("zigry-loader");if(loader){loader.classList.add("d-none")}
zScroll();initEmoji();reverse_counter()});async function decryptAndSetMediaLb(el){if(!el||!el.dataset.url||el.dataset.decryptedSrc)return;try{const res=await fetch(el.dataset.url);const buffer=await res.arrayBuffer();const data=new Uint8Array(buffer);const mimeLen=(data[0]<<8)+data[1];const mime=new TextDecoder().decode(data.slice(2,2+mimeLen));const offset=2+mimeLen;const key=data.slice(offset,offset+32);const iv=data.slice(offset+32,offset+48);const cipher=data.slice(offset+48);const cryptoKey=await crypto.subtle.importKey("raw",key,{name:"AES-CBC"},!1,["decrypt"]);const decrypted=await crypto.subtle.decrypt({name:"AES-CBC",iv},cryptoKey,cipher);const blob=new Blob([decrypted],{type:mime});const objectUrl=URL.createObjectURL(blob);el.dataset.decryptedSrc=objectUrl;el.dataset.url=objectUrl;el.dataset.full=objectUrl}catch(err){console.error("[decryptAndSetMediaLb] Failed to decrypt:",err)}}
document.addEventListener("DOMContentLoaded",zvalid);function zvalid(){const inputs=document.querySelectorAll("input, textarea, select");inputs.forEach((input)=>{if(input.type==="radio"||input.type==="checkbox"){const radioInputs=document.querySelectorAll(`[name="${input.name}"]`);radioInputs.forEach((radioInput)=>{radioInput.addEventListener("invalid",(event)=>{event.preventDefault();const errorMessage={};errorMessage[input.name]=getErrorMessage(radioInput);const errorMessageElement=radioInputs[0].parentNode.querySelector(".notify-error");if(errorMessageElement){errorMessageElement.querySelector(".notify-text").innerHTML=errorMessage[input.name];errorMessageElement.style.display="block"}else{zigry.notify(errorMessage,"danger");const newErrorMessageElement=radioInputs[0].parentNode.querySelector(`.notify-wrapper`);if(newErrorMessageElement){newErrorMessageElement.classList.add("notify-error")}}})});radioInputs.forEach((radioInput)=>{radioInput.addEventListener("change",(event)=>{const errorMessageElement=radioInputs[0].parentNode.querySelector(".notify-error");if(errorMessageElement&&document.querySelectorAll(`[name="${input.name}"]:checked`).length>0){errorMessageElement.style.display="none"}})})}else{input.addEventListener("invalid",(event)=>{event.preventDefault();const errorMessage={};errorMessage[input.name]=getErrorMessage(input);const errorMessageElement=input.parentNode.querySelector(".notify-error");if(errorMessageElement){errorMessageElement.querySelector(".notify-text").innerHTML=errorMessage[input.name];errorMessageElement.style.display="block"}else{zigry.notify(errorMessage,"danger");const newErrorMessageElement=input.parentNode.querySelector(`.notify-wrapper`);if(newErrorMessageElement){newErrorMessageElement.classList.add("notify-error")}}});input.addEventListener("input",(event)=>{const errorMessageElement=input.parentNode.querySelector(".notify-error");if(errorMessageElement){if(input.validity.valid){errorMessageElement.style.display="none"}else{errorMessageElement.querySelector(".notify-text").innerHTML=getErrorMessage(input);errorMessageElement.style.display="block"}}
if(input.type==="tel"){let value=event.target.value;value=value.replace(/\D/g,"");if(value.startsWith("0")&&value.length>1){value=value.replace(/^0+/,"")}
event.target.value=value}
if(input.type==="otp"){let value=event.target.value;value=value.replace(/\D/g,"");event.target.value=value}})}});function getErrorMessage(input){const v=input.validity;const m=window.validation;if((input.type==="radio"||input.type==="checkbox")&&v.valueMissing){return m.valueMissingOptions}
for(let key in v){if(v[key]&&m[key])return m[key]}
return input.validationMessage}}
class ZigryBS{constructor(el){this.el=el;if(!this.el.hasAttribute("role")){this.el.setAttribute("role","dialog")}
this.el.addEventListener("click",(e)=>{const isStatic=this.el.getAttribute("data-bs-backdrop")==="static";if(e.target===this.el){if(e.target===this.el){if(isStatic){this.animateStatic()}else{this.hide()}}}else if(e.target.closest('[data-bs-dismiss="modal"]')){this.hide()}});document.addEventListener("keydown",(e)=>{if(e.key==="Escape"&&this.el.classList.contains("show")){const isStatic=this.el.getAttribute("data-bs-backdrop")==="static";if(!isStatic)this.hide();}})}
animateStatic(){const animations=["modal-deny-wiggle","modal-deny-pulse","modal-static","modal-deny-bounce",];const random=animations[Math.floor(Math.random()*animations.length)];this.el.classList.add(random);setTimeout(()=>{this.el.classList.remove(random)},400)}
show(){replaceZigryIcons();this.el.removeAttribute("aria-hidden");this.el.setAttribute("aria-modal","true");this.el.style.display="block";requestAnimationFrame(()=>this.el.classList.add("show"));this.addBackdrop();document.body.classList.add("modal-open")}
hide(){if(document.activeElement&&this.el.contains(document.activeElement)){document.activeElement.blur()}
this.el.classList.remove("show");setTimeout(()=>{this.el.style.display="none";this.el.setAttribute("aria-hidden","true");this.el.removeAttribute("aria-modal")},200);this.removeBackdrop();document.body.classList.remove("modal-open")}
addBackdrop(){if(!document.querySelector(".modal-backdrop")){const backdrop=document.createElement("div");backdrop.className="modal-backdrop fade show";document.body.appendChild(backdrop)}}
removeBackdrop(){const backdrop=document.querySelector(".modal-backdrop");if(backdrop)backdrop.remove();}
static initAll(){document.querySelectorAll('[data-bs-toggle="modal"]').forEach((btn)=>{if(btn._zigryInit)return;const targetSelector=btn.getAttribute("data-bs-target");const modalEl=document.querySelector(targetSelector);if(!modalEl)return;if(!modalEl._ZigryBS){modalEl._ZigryBS=new ZigryBS(modalEl)}
btn.addEventListener("click",(e)=>{e.preventDefault();modalEl._ZigryBS.show()});btn._zigryInit=!0});document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach((btn)=>{if(btn._zigryddInit)return;const parent=btn.closest(".dropdown, .dropdown-center");const menu=parent?.querySelector(".dropdown-menu");if(!menu)return;btn.addEventListener("click",(e)=>{e.preventDefault();document.querySelectorAll(".dropdown-menu.show").forEach((openMenu)=>{if(openMenu!==menu)openMenu.classList.remove("show");});menu.classList.toggle("show")});document.addEventListener("click",(e)=>{if(!parent.contains(e.target)){menu.classList.remove("show")}});menu.addEventListener("click",(e)=>{if(e.target.closest(".dropdown-item")){menu.classList.remove("show")}});btn._zigryddInit=!0})}}
class ZigrySparkScroll{constructor(s,t,o={}){this.s=s;this.t=t;this.c=o.colors||["#ff0040","#ff9000","#ffff00","#00ff90","#00ffd0","#9000ff","#ff00d0","#ff1493","#00ced1","#ffa500",];this.d=[];this.ls=s.scrollTop;this.h=!1;this.wrapper=this.t.parentElement||document.body;this._computeOffsets();this.i()}
_computeOffsets(){const sRect=this.s.getBoundingClientRect();const wRect=this.wrapper.getBoundingClientRect();this.offsetTopWithinWrapper=Math.max(0,sRect.top-wRect.top);this.visibleHeight=this.s.clientHeight;this.scrollHeight=this.s.scrollHeight}
i(){this.u();window.addEventListener("resize",()=>{this._computeOffsets();this.u()});this.s.addEventListener("scroll",()=>this.u());this.drag=!1;this.t.addEventListener("mousedown",(e)=>{e.preventDefault();this.drag=!0;this.sy=e.clientY;this.st=parseFloat(this.t.style.top)||0;document.documentElement.classList.add("no-select")});document.addEventListener("mousemove",(e)=>{if(!this.drag)return;this._computeOffsets();const ch=this.visibleHeight;const sh=this.scrollHeight;const th=this.t.offsetHeight;const track=ch-th;const dy=e.clientY-this.sy;const newTop=Math.max(0,Math.min(track,this.st+dy));const newScrollTop=(newTop/track)*(sh-ch);this.s.scrollTop=newScrollTop});document.addEventListener("mouseup",()=>{this.drag=!1;document.documentElement.classList.remove("no-select")});this.t.addEventListener("mouseenter",()=>(this.h=!0));this.t.addEventListener("mouseleave",()=>(this.h=!1));this.t.addEventListener("mousedown",()=>{for(let i=0;i<4;i++)this.cS();});this.ctx=this.t.getContext("2d");this.a()}
u(){this._computeOffsets();const ch=this.visibleHeight;const sh=this.s.scrollHeight;if(sh<=ch){this.t.style.display="none";return}
this.t.style.display="block";const th=Math.max(Math.floor((ch/sh)*ch),20);const track=ch-th;const scrollRatio=sh-ch<=0?0:this.s.scrollTop/(sh-ch);const topPos=this.offsetTopWithinWrapper+scrollRatio*track;this.t.style.height=`${th}px`;this.t.style.top=`${Math.round(topPos)}px`}
cS(){const th=this.t.offsetHeight,tw=this.t.offsetWidth;const a=Math.random()*2*Math.PI;const s=0.5+Math.random()*1.2;this.d.push({x:Math.random()*tw,y:Math.random()*th,r:3+Math.random()*4,mr:1+Math.random()*1.5,a:1,c:this.c[Math.floor(Math.random()*this.c.length)],vx:Math.cos(a)*s,vy:Math.sin(a)*s,})}
sS(speed){if(speed>1){const count=Math.max(1,Math.floor(this.t.offsetHeight/40));for(let i=0;i<count;i++)if(Math.random()<0.5)this.cS();}}
a(){const th=this.t.offsetHeight,tw=this.t.offsetWidth;const dpr=window.devicePixelRatio||1;this.t.width=Math.max(1,Math.floor(tw*dpr));this.t.height=Math.max(1,Math.floor(th*dpr));this.t.style.width=`${tw}px`;this.t.style.height=`${th}px`;this.ctx.setTransform(dpr,0,0,dpr,0,0);this.ctx.clearRect(0,0,tw,th);const spd=Math.min(50,Math.abs(this.s.scrollTop-this.ls));this.ls=this.s.scrollTop;this.sS(spd);this.ctx.fillStyle=this.h?"rgba(127,34,241,.3)":"rgba(127,34,241,.15)";this.ctx.fillRect(0,0,tw,th);this.d.forEach((d)=>{const g=this.ctx.createRadialGradient(d.x,d.y,0,d.x,d.y,d.r);g.addColorStop(0,d.c);g.addColorStop(1,"rgba(0,0,0,0)");this.ctx.fillStyle=g;this.ctx.globalAlpha=d.a;this.ctx.fillRect(0,0,tw,th);d.x+=d.vx;d.y+=d.vy;d.r+=0.05+d.mr*0.05;d.a-=0.01});this.d=this.d.filter((d)=>d.a>0);this.ctx.globalAlpha=1;requestAnimationFrame(()=>this.a())}}
function zScroll(){const applyScroll=(el)=>{if(el.dataset.zigryScrollApplied)return;if(el.scrollHeight<=el.clientHeight)return;el.style.scrollbarWidth="none";el.style.msOverflowStyle="none";el.style.overflowY="auto";const unique="zs_"+Math.random().toString(36).slice(2,8);el.classList.add(unique);const st=document.createElement("style");st.textContent=`
      .${unique}::-webkit-scrollbar {
        width: 0 !important;
        height: 0 !important;
        display: none !important;
      }
    `;document.head.appendChild(st);let wrapper=el.parentElement||document.body;if(getComputedStyle(wrapper).position==="static"){wrapper.style.position="relative"}
const thumb=document.createElement("canvas");thumb.className="zigry-thumb";Object.assign(thumb.style,{position:"absolute",right:"2px",width:"8px",borderRadius:"4px",pointerEvents:"auto",zIndex:"9999",background:"transparent",});wrapper.appendChild(thumb);new ZigrySparkScroll(el,thumb);el.dataset.zigryScrollApplied="true"};const observer=new IntersectionObserver((entries)=>{entries.forEach((entry)=>{const el=entry.target;const style=getComputedStyle(el);if(style.display==="none"||style.visibility==="hidden"||el.offsetParent===null){el.dataset.zigryScrollApplied="";const thumb=el.parentElement?.querySelector(".zigry-thumb");if(thumb)thumb.remove();return}
if(entry.isIntersecting&&(style.overflowY==="auto"||style.overflowY==="scroll")&&el.scrollHeight>el.clientHeight&&!el.dataset.zigryScrollApplied){applyScroll(el)}})},{threshold:0});document.querySelectorAll("*").forEach((el)=>{const style=getComputedStyle(el);if(style.overflowY==="auto"||style.overflowY==="scroll"){observer.observe(el)}})}
document.addEventListener("click",function(e){if(e.target.closest(".z-scroll")){zScroll()}});function replaceZigryIcons(root=document){root.querySelectorAll("span.zigry[class*='z-'], i.zigry[class*='z-'], div.zigry[class*='z-']").forEach((el)=>{const match=el.className.match(/z-([\w-]+)/);if(!match)return;const iconName=match[0];const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");const use=document.createElementNS("http://www.w3.org/2000/svg","use");svg.setAttribute("class",el.className);if(el.hasAttribute("aria-label")){svg.setAttribute("role","img");svg.setAttribute("aria-label",el.getAttribute("aria-label"))}else if(!el.hasAttribute("aria-hidden")){svg.setAttribute("aria-hidden","true")}
use.setAttribute("href",`#${iconName}`);use.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",`#${iconName}`);svg.appendChild(use);el.replaceWith(svg)})}
function initApp(){replaceZigryIcons();bindZigryLightbox();ZigryBS.initAll()}
window.bootstrap=window.bootstrap||{};bootstrap.Modal=class{constructor(el){if(!el)throw new Error("ZigryBS: modal element not found");if(!el._ZigryBS)el._ZigryBS=new ZigryBS(el);this.instance=el._ZigryBS}
show(){this.instance.show()}
hide(){this.instance.hide()}
static getInstance(el){return el?._ZigryBS||new ZigryBS(el)}};(function(){if(typeof window==="undefined")return;console.log("%c‚ö†Ô∏è SECURITY WARNING!","color:#fff;background:#dc3545;padding:6px;font-size:16px;");console.log("%cNever paste code here. It may compromise your account!","color:#dc3545;font-size:14px;");const devtools={isOpen:!1,orientation:undefined};const threshold=170;function checkDevTools(){const widthThreshold=window.outerWidth-window.innerWidth>threshold;const heightThreshold=window.outerHeight-window.innerHeight>threshold;const orientation=widthThreshold?"vertical":"horizontal";const detected=!(heightThreshold&&widthThreshold)&&((window.Firebug&&window.Firebug.chrome&&window.Firebug.chrome.isInitialized)||widthThreshold||heightThreshold);if(detected){devtools.isOpen=!0;devtools.orientation=orientation}else{devtools.isOpen=!1;devtools.orientation=undefined}
return devtools.isOpen}
let opened=!1;setInterval(()=>{const isOpen=checkDevTools();if(isOpen&&!opened){opened=!0;if(typeof zigry!=="undefined"&&typeof zigry.alert==="function"){zigry.alert({title:"‚ö†Ô∏è Security Warning",message:"Developer tools are open. For your safety, do not paste any scripts in the console.",type:"warning",buttons:[{label:"I Understand",class:"btn btn-danger",value:!0},],multiple:!1,duration:null,})}}else if(!isOpen&&opened){opened=!1;const zone=document.getElementById("toastZone");if(zone){zone.querySelectorAll(".zigry-toast").forEach((toast)=>{const buttons=toast.querySelectorAll("button");if(buttons.length)buttons[0].click();else{toast.remove();zone.style.display="none";window.alertOpen=!1;if(window.queue)window.queue.shift?.();}})}}},500)})();function initEmoji(){const btn=document.getElementById("emoji-btn");if(!btn)return;const categories={Smileys:"üòÄ üòÉ üòÑ üòÅ üòÜ üòÖ üòÇ ü§£ üòä üòá üôÇ üôÉ üòâ üòç ü•∞ üòò üòó üòô üòö üòã üòõ üòù üòú ü§™ ü§® üßê ü§ì üòé ü•∏ ü§© ü•≥ üòè üòí üòû üòî üòü üòï üôÅ ‚òπÔ∏è üò£ üòñ üò´ üò© ü•∫ üò¢ üò≠ üò§ üò† üò° ü§¨ üò∂ üòê üòë ü§î üôÑ ü§• ü§≠ ü§´ ü§ó ü§î ü´† ü§ê ü•¥ ü§¢ ü§Æ ü§ß üò∑ ü§í ü§ï ü§ë ü§†",Animals:"üê∂ üê± üê≠ üêπ üê∞ ü¶ä üêª üêº üê® üêØ ü¶Å üêÆ üê∑ üê∏ üêµ üêî üêß üê¶ üê§ üê£ üê∫ üêó ü¶Ü ü¶Ö ü¶â üê¥ ü¶Ñ üêù üêõ ü¶ã üêå üêû üêú üï∑Ô∏è ü¶Ç üê¢ üêç ü¶é üêô üê† üêü üê¨ üê≥ üêã ü¶à ü¶Ä üêä",Food:"üçè üçé üçê üçä üçã üçå üçâ üçá üçì ü´ê üçà üçí üçë ü•≠ üçç ü•• ü•ù üçÖ üçÜ ü•ë ü•¶ ü•¨ ü•í üå∂Ô∏è ü´ë üåΩ ü•ï ü•î üßÑ üßÖ ü•ê üçû ü•ñ ü•® ü•Ø üßá üßÄ üçñ üçó ü•© ü•ì üçî üçü üçï üå≠ üåÆ üåØ ü•ó ü•ô üçù üç£ üç± üç§ üçô üçö üçõ üçú üç≤ ü´ï ü•ò üç• üßÅ üç∞ üç© üç™ üç´ üçø üç© üç¶ üç® üçß üßÉ ‚òï üçµ üßã ü•§ ü•õ üç∫ üçª ü•Ç üç∑ ü•É üç∏ üçπ üßâ",Activities:"‚öΩ üèÄ üèà ‚öæ üéæ üèê üèâ üé± ü™Ä üèì üè∏ ü•Ö üèí üèë ü•ç üèè ‚õ≥ üèπ üé£ ü§ø ü•ä ü•ã üõπ üõº üõ∑ ‚õ∏Ô∏è ü•å üéø ‚õ∑Ô∏è üèÇ ü™Ç üö¥ üöµ üèá üèÑ üèä ü§Ω ü§æ üßó üèãÔ∏è ü§∏ ü§π üßò üéØ üé≥ üéÆ üé∞ üé≤ üß© ü™Ö üé≠ üé® üé§ üéß üé∏ üéπ ü•Å üéª üé¨ üé• üì∏ üìπ üéûÔ∏è üì∫ üìª üìº",Objects:"‚åö üì± üíª üñ•Ô∏è üñ®Ô∏è üñ±Ô∏è üñ≤Ô∏è üíΩ üíæ üíø üìÄ üì∏ üì∑ üìπ üé• üìû ‚òéÔ∏è üìü üì† üì∫ üìª üß≠ ‚è∞ ‚è±Ô∏è ‚è≤Ô∏è üï∞Ô∏è üïπÔ∏è üßÆ üí° üî¶ üïØÔ∏è ü™î üßØ üîã ü™´ üîå üí∏ üí∞ üí≥ üíé ‚öñÔ∏è üß∞ üîß üî® ‚öíÔ∏è ü™ì ü™ö üî© ‚öôÔ∏è üß± üß≤ üî´ ü™Ñ üßΩ üß¥ üíä üíâ ü©∫ ü©π üß¨ üß´ üß™ üå°Ô∏è",Symbols:"‚ù§Ô∏è üß° üíõ üíö üíô üíú ü§é üñ§ ü§ç üíî ‚ù§Ô∏è‚Äçüî• ‚ù§Ô∏è‚Äçü©π üíò üíù üíñ üíó üíì üíû üíï üíü ‚òÆÔ∏è ‚úùÔ∏è ‚ò™Ô∏è üïâÔ∏è ‚ò∏Ô∏è ‚ú°Ô∏è üîØ üïé ‚òØÔ∏è ‚ò¶Ô∏è üõê ‚õé ‚ôà ‚ôâ ‚ôä ‚ôã ‚ôå ‚ôç ‚ôé ‚ôè ‚ôê ‚ôë ‚ôí ‚ôì üîÄ üîÅ üîÇ ‚è© ‚è™ ‚è´ ‚è¨ üîº üîΩ ‚èπÔ∏è ‚è∫Ô∏è ‚èèÔ∏è üé¶ üîÖ üîÜ üì∂ üì≥ üì¥",};const picker=document.getElementById("emoji-picker");const categoryBar=document.getElementById("emoji-categories");const grid=document.getElementById("emoji-grid");const input=document.getElementById("richPostEditor");let pickerVisible=!1;let activeCategory="Smileys";for(const[category,emojis]of Object.entries(categories)){const catBtn=document.createElement("button");catBtn.textContent=emojis.split(" ")[0];catBtn.title=category;catBtn.classList.add("btn");catBtn.classList.add("btn-default");catBtn.classList.add("z-scroll");if(category===activeCategory)catBtn.classList.add("active");catBtn.addEventListener("click",(e)=>{e.stopPropagation();document.querySelectorAll(".emoji-categories button").forEach((b)=>b.classList.remove("active"));catBtn.classList.add("active");activeCategory=category;renderEmojis(categories[category])});categoryBar.appendChild(catBtn)}
function renderEmojis(emojiStr){grid.innerHTML="";emojiStr.split(" ").forEach((e)=>{if(!e.trim())return;const span=document.createElement("span");span.textContent=e;span.addEventListener("click",(ev)=>{ev.stopPropagation();input.innerText+=e});grid.appendChild(span)})}
renderEmojis(categories[activeCategory]);btn.addEventListener("click",(e)=>{e.stopPropagation();pickerVisible=!pickerVisible;picker.classList.toggle("d-none",!pickerVisible)});picker.addEventListener("click",(e)=>e.stopPropagation());document.addEventListener("click",()=>{picker.classList.add("d-none");pickerVisible=!1})}
function processPostLinks(){const postContents=document.querySelectorAll('.content:not([data-processed="true"])');const urlRegex=/(https?:\/\/[^\s<>"']+)/g;postContents.forEach((contentDiv)=>{contentDiv.dataset.processed="true";const contentText=contentDiv.textContent;const urls=contentText.match(urlRegex);if(urls&&urls.length>0){const url=urls[0];const placeholder=createOgPreviewCard(null,url);contentDiv.insertAdjacentElement("afterend",placeholder);fetch("/fetch-og",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),},body:JSON.stringify({url:url}),}).then((response)=>response.json()).then((result)=>{if(result.success&&result.data&&(result.data["og:title"]||result.data["og:image"])){const newCard=createOgPreviewCard(result.data,url);placeholder.replaceWith(newCard)}else{placeholder.remove()}}).catch((error)=>{console.error("Error fetching OG data:",error);console.error("Error fetching OG data via server proxy:",error);placeholder.remove()})}})}
function createOgPreviewCard(data,url){const card=document.createElement("a");card.href=`/url?link=${encodeURIComponent(url)}`;card.target="_blank";card.rel="nofollow noopener noreferrer";card.className="og-preview-card card text-decoration-none my-0 border-0";if(!data){card.innerHTML=`
            <div class="card-body">
                <div class="placeholder-glow">
                    <span class="placeholder col-7"></span>
                    <span class="placeholder col-4"></span>
                    <span class="placeholder col-4"></span>
                    <span class="placeholder col-6"></span>
                </div>
            </div>`;return card}
const imageUrl=data["og:image"]?`<img src="${data["og:image"]}" class="img-thumbnail object-fit-cover" style="width: 100%;max-height: 277px;" alt="${data["og:title"]}" onerror="this.style.display='none'"/>`:"";const title=data["og:title"]?`<div class="og-title fw-bold text-truncate">${data["og:title"]}</div>`:`<div class="og-title fw-bold text-truncate">${url}</div>`;const description=data["og:description"]?`<div class="og-description small text-muted text-wrap">${data["og:description"]}</div>`:"";const siteName=data["og:site_name"]||new URL(url).hostname;const faviconUrl=data.favicon;card.innerHTML=`
<div class="card-body overflow-hidden" style="max-width: 100%;">
  <div class="d-grid">
    ${imageUrl}
    <div class="overflow-hidden text-wrap flex-grow-1 mt-1" style="min-width: 0;">
      <div class="ms-1 mb-2 text-truncate small">${title}</div>
      <div class="ms-1 text-wrap smaller">${description}</div>
    </div>
  </div>
  <div class="og-footer d-flex align-items-center gap-1 overflow-hidden justify-content-end mt-2 small" style="min-width: 0;">
    <img src="${faviconUrl}" class="og-favicon" alt="Favicon" width="12" height="12" onerror="this.style.display='none'"/>
    <small class="text-muted text-truncate">${siteName}</small>
  </div>
</div>
    `;return card}
function reverse_counter(){var el=document.getElementById("reverse_counter");if(el){function incrementSeconds(){if(el.innerText>0){el.innerText=el.innerText-1;if(el.innerText==0){zigry.navigate(location.pathname)}}}
var cancel=setInterval(incrementSeconds,1000)}}
document.addEventListener("DOMContentLoaded",()=>{const COOKIE_CONSENT_KEY="zigry_cookie_consent";const banner=document.getElementById("cookie-consent-banner");if(!banner)return;const acceptBtn=document.getElementById("cookie-consent-accept");const declineBtn=document.getElementById("cookie-consent-decline");function updateConsent(granted){window.dataLayer=window.dataLayer||[];dataLayer.push({event:"consent_update",analytics_storage:granted?"granted":"denied",ad_storage:granted?"granted":"denied",ad_user_data:granted?"granted":"denied",ad_personalization:granted?"granted":"denied",})}
function setConsentCookie(value){const expiry=new Date();expiry.setFullYear(expiry.getFullYear()+1);document.cookie=`${COOKIE_CONSENT_KEY}=${value}; expires=${expiry.toUTCString()}; path=/; SameSite=Lax`;banner.classList.add("d-none")}
const existing=document.cookie.split("; ").find((c)=>c.startsWith(COOKIE_CONSENT_KEY+"="));if(existing){const val=existing.split("=")[1];updateConsent(val==="granted")}else{banner.classList.remove("d-none")}
acceptBtn?.addEventListener("click",()=>{updateConsent(!0);setConsentCookie("granted")});declineBtn?.addEventListener("click",()=>{updateConsent(!1);setConsentCookie("denied")})});function initTabs(){document.querySelectorAll('[data-bs-toggle="tab"]').forEach((tab)=>{tab.addEventListener("click",(e)=>{e.preventDefault();const targetSelector=tab.getAttribute("data-bs-target");const targetPane=document.querySelector(targetSelector);if(!targetPane)return;const container=tab.closest(".nav-tabs");if(container){container.querySelectorAll(".nav-link").forEach((t)=>t.classList.remove("active"))}
const contentContainer=targetPane.closest(".tab-content");if(contentContainer){contentContainer.querySelectorAll(".tab-pane").forEach((p)=>{p.classList.remove("show","active")})}
tab.classList.add("active");targetPane.classList.add("show","active")})})}
document.addEventListener("DOMContentLoaded",initTabs);const csrfToken=document.querySelector('meta[name="csrf-token"]')['content'];function speak(text){const utterance=new SpeechSynthesisUtterance(text);const voices=speechSynthesis.getVoices();utterance.voice=voices[10];speechSynthesis.speak(utterance)}
const startButton=document.getElementById('mic')??!1;let mediaStream=null;if(startButton){startButton.addEventListener('click',async()=>{alert(1)
try{mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0});const audioContext=new(window.AudioContext||window.webkitAudioContext)();const source=audioContext.createMediaStreamSource(mediaStream);const analyser=audioContext.createAnalyser();source.connect(analyser)}catch(error){console.error('Error accessing microphone:',error)}})}
function updateDynamicTime(){document.querySelectorAll('.date').forEach((element)=>{const timestamp=element.getAttribute('data-timestamp');if(timestamp){try{element.textContent=humanReadableTime(timestamp);const diffInSeconds=Math.floor((new Date()-new Date(parseTime(timestamp)*1000))/1000);if(diffInSeconds<60){}else if(diffInSeconds>60&&diffInSeconds<3600){setTimeout(updateDynamicTime,60*1000)}else{setTimeout(updateDynamicTime,60*60*1000)}}catch(e){element.textContent="Invalid timestamp"}}})}
function parseTime(input){if(input instanceof Date)return input;const num=Number(input);if(!isNaN(num)){if(input.toString().length===10)return new Date(num*1000);if(input.toString().length===13)return new Date(num);}
const customMatch=input.match(/^(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2}):(\d{2})$/);if(customMatch){const[,dd,mm,yyyy,hh,min,ss]=customMatch;return new Date(`${yyyy}-${mm}-${dd}T${hh}:${min}:${ss}`)}
const parsed=new Date(input);if(!isNaN(parsed.getTime()))return parsed;throw new Error("Invalid date input")}
function humanReadableTime(input){const now=new Date();let time=parseTime(input);try{const diffInSeconds=Math.floor((now-time)/1000);const isPast=diffInSeconds>=0;const absDiffInSeconds=Math.abs(diffInSeconds);if(absDiffInSeconds<60){return `Just now`}else if(absDiffInSeconds<3600){const minutes=Math.floor(absDiffInSeconds/60);return `${isPast ? '' : 'before'} ${minutes} ${minutes === 1 ? 'minute' : 'minutes'} ${isPast ? 'ago' : ''}`}else if(absDiffInSeconds<86400){const hours=Math.floor(absDiffInSeconds/3600);return `${isPast ? '' : 'before'} ${hours} ${hours === 1 ? 'hour' : 'hours'} ${isPast ? 'ago' : ''}`}else if(absDiffInSeconds<2592000){const days=Math.floor(absDiffInSeconds/86400);return `${isPast ? '' : 'before'} ${days} ${days === 1 ? 'day' : 'days'} ${isPast ? 'ago' : ''}`}else if(absDiffInSeconds<31536000){const months=Math.floor(absDiffInSeconds/2592000);return `${isPast ? '' : 'before'} ${months} ${months === 1 ? 'month' : 'months'} ${isPast ? 'ago' : ''}`}else{const years=Math.floor(absDiffInSeconds/31536000);return `${isPast ? '' : 'before'} ${years} ${years === 1 ? 'year' : 'years'} ${isPast ? 'ago' : ''}`}}catch(error){console.error("Error in humanReadableTime function:",error.message);return"Invalid date input."}}
updateDynamicTime();function getLocation(){return new Promise((resolve,reject)=>{navigator.geolocation.getCurrentPosition((position)=>resolve(position),(error)=>reject(error))})}
async function getUserCoordinates(){try{const position=await getLocation();const{latitude,longitude,accuracy}=position.coords;return position.coords}catch(error){console.error(error)}}
const storageKey="searchRecords";function getSearchRecords(){const records=sessionStorage.getItem(storageKey);return records?JSON.parse(records):[]}
function saveSearchRecords(records){sessionStorage.setItem(storageKey,JSON.stringify(records))}
function addSearchRecord(searchTerm){let records=getSearchRecords();const existingIndex=records.findIndex(record=>record.term===searchTerm);if(existingIndex!==-1){records[existingIndex].time=new Date().toISOString()}else{records.push({term:searchTerm,time:new Date().toISOString()})}
records.sort((a,b)=>new Date(b.time)-new Date(a.time));records=records.slice(0,10);saveSearchRecords(records)}
function updateDropdown(records){const dropdownList=document.getElementById("dropdown-list");dropdownList.innerHTML="";records.forEach(record=>{const item=document.createElement("div");item.className="dropdown-item";item.textContent=record.term;item.addEventListener("click",()=>{const searchInput=document.getElementById("search");searchInput.value=record.term;dropdownList.classList.remove("active");searchInput.form.submit()});dropdownList.appendChild(item)});if(records.length>0){dropdownList.classList.add("active")}else{dropdownList.classList.remove("active")}}
async function fetchServerSuggestions(query){try{const response=await fetch(`/search-suggestions?query=${encodeURIComponent(query)}`);if(response.ok){const suggestions=await response.json();return suggestions.map(term=>({term,time:new Date().toISOString()}))}else{console.error("Failed to fetch server suggestions");return[]}}catch(error){console.error("Error fetching suggestions:",error);return[]}}
async function fetchAndCombineSuggestions(query){const localRecords=getSearchRecords();const filteredLocalRecords=localRecords.filter(record=>record.term.toLowerCase().includes(query.toLowerCase()));const serverSuggestions=await fetchServerSuggestions(query);const combined=[...filteredLocalRecords];serverSuggestions.forEach(serverRecord=>{if(!combined.some(localRecord=>localRecord.term===serverRecord.term)){combined.push(serverRecord)}});combined.sort((a,b)=>new Date(b.time)-new Date(a.time));updateDropdown(combined.slice(0,5))}
function setupEventListeners(){const searchInput=document.getElementById("search");const dropdownList=document.getElementById("dropdown-list");searchInput?.addEventListener("input",debounce(async event=>{const query=event.target.value.trim();if(query){await fetchAndCombineSuggestions(query)}else{dropdownList?.classList.remove("active")}},1000));document.getElementById("search-button")?.addEventListener("click",()=>{const query=searchInput.value.trim();if(query){addSearchRecord(query)}});document.getElementById("search-magic")?.addEventListener("click",()=>{const query=searchInput.value.trim();if(query){addSearchRecord(query)}});document.addEventListener("click",event=>{if(!event.target.closest(".dropdown")){dropdownList?.classList?.remove("active")}})}
function debounce(func,delay){let timer;return(...args)=>{clearTimeout(timer);timer=setTimeout(()=>func(...args),delay)}}
document.addEventListener("DOMContentLoaded",()=>{setupEventListeners()});async function fetchSuggestion(query){try{const response=await fetch(`/suggestion/handler?query=${encodeURIComponent(query)}`);if(response.ok){const data=await response.json();return data.suggestion||null}else{console.error("Failed to fetch suggestion");return null}}catch(error){console.error("Error fetching suggestion:",error);return null}}
function displaySuggestion(suggestion){const suggestionContainer=document.getElementById("suggestion-container");if(suggestion){suggestionContainer.innerHTML=`Did you mean <a href="#" id="suggestion-link">${suggestion}</a>?`;suggestionContainer.style.display="block";const suggestionLink=document.getElementById("suggestion-link");suggestionLink.addEventListener("click",(event)=>{event.preventDefault();const searchInput=document.getElementById("search");searchInput.value=suggestion;searchInput.form.submit()})}else{suggestionContainer.style.display="none"}}
async function handleSearch(event){const searchInput=document.getElementById("search");const query=searchInput.value.trim();if(!query){event.preventDefault();return}
const suggestion=await fetchSuggestion(query);displaySuggestion(suggestion)}
function urlB64ToUint8Array(base64String){const padding='='.repeat((4-base64String.length%4)%4);const base64=(base64String+padding).replace(/-/g,'+').replace(/_/g,'/');const rawData=window.atob(base64);return new Uint8Array([...rawData].map((char)=>char.charCodeAt(0)))}
function sendSubscriptionToServer(subscription){fetch('/subscribe',{method:'POST',body:JSON.stringify(subscription),headers:{'X-Requested-With':'Zigry-Ajax','X-CSRF-Token':csrfToken,'Content-Type':'application/json'}}).then(response=>{if(response.ok){console.log('Subscribed successfully')}}).catch(err=>{console.error('Error subscribing:',err)})}
function createNotification(title,icon,body,url){var notification=new Notification(title,{icon:icon,body:body,});notification.onclick=function(){window.open(url)};return notification};let currentEditingPostId=null;let selectedMediaFiles=[];function togglePostBox(force=null){const box=document.getElementById('richPostBox');const togglepost=document.getElementById('togglepost');const togglebtn=document.getElementById('togglebtn');const richPostEditor=document.getElementById('richPostEditor');box.style.display=force===!1?'none':force===!0?'block':box.style.display==='none'?'block':'none';togglebtn.style.display=force===!1?'none':force===!0?'block':box.style.display==='none'?'block':'none';togglepost.style.display=force===!0?'none':force===!1?'block':box.style.display==='none'?'block':'none';if(box.style.display=='block'){richPostEditor.focus()}}
function cancelPost(){document.getElementById('richPostEditor').innerHTML='';document.getElementById('mediaPreview').innerHTML='';selectedMediaFiles=[];document.getElementById('linkPreview').innerHTML='';document.getElementById('linkPreview').classList.add('d-none');document.getElementById('mediaInput').value='';document.getElementById('locationTag').innerHTML='';document.getElementById('locationTag').classList.add('d-none');const privacySelect=document.getElementById('privacySelect');if(privacySelect)privacySelect.value='public';currentEditingPostId=null;const postBtn=document.getElementById('postSubmitBtn');if(postBtn)postBtn.textContent='Post';togglePostBox(!1);renderAddMoreTile()}
function exec(command){document.execCommand(command,!1,null)}
function setEditorColor(color){document.getElementById("richPostEditor").style.backgroundColor=color}
document.querySelectorAll('.color-btn').forEach(btn=>{btn.addEventListener('click',()=>{const color=btn.style.background;setEditorColor(color)})});async function handleInput(){const editor=document.getElementById("richPostEditor");const text=editor.innerText.trim();const linkPreview=document.getElementById("linkPreview");const urlMatch=text.match(/https?:\/\/[^\s]+/);if(urlMatch){fetch(`/api/og-meta?url=${encodeURIComponent(urlMatch[0])}`).then(res=>res.json()).then(meta=>{linkPreview.innerHTML=`
          <div class="d-flex">
            <img src="${meta.image}" alt="OG Image" class="me-2" width="100">
            <div>
              <div class="fw-bold">${meta.title}</div>
              <div class="text-muted small">${meta.description}</div>
              <div class="text-primary small">${meta.site_name}</div>
            </div>
          </div>
        `;linkPreview.classList.remove("d-none")})}else{linkPreview.classList.add("d-none")}
editor.classList.toggle("fs-3",text.length<=160)}
function tagLocation(){const locTag=document.getElementById('locationTag');navigator.geolocation.getCurrentPosition(pos=>{const{latitude,longitude}=pos.coords;locTag.classList.remove('d-none');locTag.textContent=`üìç Location: (${latitude.toFixed(4)}, ${longitude.toFixed(4)})`;locTag.dataset.coords=`${latitude},${longitude}`},()=>{locTag.classList.remove('d-none');locTag.textContent='üìç Location tagging failed.'})}
async function submitPost(){const editor=document.getElementById('richPostEditor');const mediaInput=document.getElementById('mediaInput');const linkPreview=document.getElementById('linkPreview');const locationTag=document.getElementById('locationTag');const privacySelect=document.getElementById('privacySelect');const content=editor.innerText.trim();const linkHTML=!linkPreview.classList.contains('d-none')?linkPreview.innerHTML:'';const location=locationTag.dataset.coords||'';const privacy=privacySelect?privacySelect.value:'public';const formData=new FormData();formData.append('content',content);formData.append('link',linkHTML);formData.append('location',location);formData.append('privacy',privacy);if(selectedMediaFiles.length>0){selectedMediaFiles.forEach(item=>formData.append('media[]',item.file))}else{for(let i=0;i<mediaInput.files.length;i++){formData.append('media[]',mediaInput.files[i])}}
try{let url='/api/posts/create';let placeholder=null;let method='POST';if(currentEditingPostId){url=`/api/posts/${currentEditingPostId}/edit`;formData.append('_method','PUT')}
const csrf=document.querySelector('meta[name="csrf-token"]')?.content||'';const res=await fetch(url,{method:method,headers:{'X-CSRF-TOKEN':csrf,},body:formData});const data=await res.json();if(res.ok){cancelPost();if(!currentEditingPostId){renderPosts(data.items,'prepend');initApp()}}else{zigry.alert({title:'Error',message:data.message||(currentEditingPostId?'Failed to update post.':'Failed to create post.'),type:'error'});if(placeholder){placeholder.remove()}}}catch(err){console.error(err);zigry.alert({title:'Error',message:'Something went wrong.',type:'error'})}}
window.openEditComposer=function(postId,html,privacy='public'){const editor=document.getElementById('richPostEditor');const privacySelect=document.getElementById('privacySelect');currentEditingPostId=postId;if(editor)editor.innerHTML=html||'';if(privacySelect)privacySelect.value=privacy||'public';const postBtn=document.getElementById('postSubmitBtn');if(postBtn)postBtn.textContent='Update';togglePostBox(!0);editor?.focus()}
document.getElementById('mediaInput')?.addEventListener('change',handleMediaPreviewChange);document.addEventListener('change',function(e){if(e.target&&e.target.id==='mediaInput'){handleMediaPreviewChange.call(e.target)}});async function compressImage(file,options={}){const{maxSize=200*1024,maxDimension=1920}=options;if(!file.type.startsWith('image/')){return file}
return new Promise((resolve,reject)=>{const reader=new FileReader();reader.readAsDataURL(file);reader.onerror=reject;reader.onload=(event)=>{const img=new Image();img.src=event.target.result;img.onerror=reject;img.onload=()=>{let{width,height}=img;if(width>maxDimension||height>maxDimension){if(width>height){height=Math.round((height*maxDimension)/width);width=maxDimension}else{width=Math.round((width*maxDimension)/height);height=maxDimension}}
const canvas=document.createElement('canvas');canvas.width=width;canvas.height=height;const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0,width,height);canvas.toBlob((blob)=>{if(blob.size<=maxSize){resolve(new File([blob],file.name,{type:'image/jpeg',lastModified:Date.now()}))}else{canvas.toBlob((finalBlob)=>resolve(new File([finalBlob],file.name,{type:'image/jpeg',lastModified:Date.now()})),'image/jpeg',0.7)}},'image/jpeg',0.9)}}})}
async function handleMediaPreviewChange(){const files=this.files||[];const preview=document.getElementById('mediaPreview');if(!preview)return;const newFiles=Array.from(files).slice(0,20-selectedMediaFiles.length);for(const originalFile of newFiles){const file=await compressImage(originalFile);const reader=new FileReader();reader.onload=function(e){const el=file.type.startsWith('video')?`<video controls><source src="${e.target.result}"></video>`:`<img src="${e.target.result}" class="object-fit-cover" height="100px">`;const uid=`${Date.now()}_${Math.random().toString(36).slice(2)}`;selectedMediaFiles.push({file,uid});const previewItem=document.createElement('div');previewItem.classList.add('preview-item');previewItem.dataset.uid=uid;previewItem.innerHTML=`${el}<div class="remove-btn" onclick="removePreview(this)">‚úñ</div>`;const addMoreTile=document.getElementById('addMoreTile');if(addMoreTile){preview.insertBefore(previewItem,addMoreTile)}else{preview.appendChild(previewItem)}};reader.readAsDataURL(file)}
if(newFiles.length>0){renderAddMoreTile();setTimeout(()=>applyCollage(),50)}
if(newFiles.length===0)renderAddMoreTile();}
function removePreview(element){const item=element.parentElement;const uid=item?.dataset?.uid;if(uid){selectedMediaFiles=selectedMediaFiles.filter(it=>it.uid!==uid)}
item.remove();renderAddMoreTile();setTimeout(()=>applyCollage(),50)}
function renderAddMoreTile(){const preview=document.getElementById('mediaPreview');if(!preview)return;const existing=document.getElementById('addMoreTile');const currentCount=Math.max(selectedMediaFiles.length,preview.querySelectorAll('.preview-item:not(#addMoreTile)').length);if(currentCount<=0){if(existing)existing.remove();return}
if(currentCount>=20){if(existing)existing.remove();return}
const tile=existing||document.createElement('div');tile.id='addMoreTile';tile.className='preview-item d-flex align-items-center justify-content-center border border-solid';tile.style.cursor='pointer';tile.textContent='+ More';tile.onclick=()=>{const countNow=Math.max(selectedMediaFiles.length,preview.querySelectorAll('.preview-item:not(#addMoreTile)').length);if(countNow>=20)return;document.getElementById('mediaInput')?.click()};if(!existing)preview.appendChild(tile);}
function applyCollage(){const run=()=>{const preview=document.getElementById('mediaPreview');if(!preview)return;const items=Array.from(preview.querySelectorAll('.preview-item:not(#addMoreTile)'));items.forEach(it=>{const ov=it.querySelector('.more-overlay');if(ov)ov.remove();it.style.display=''});if(items.length<=4)return;const hiddenCount=items.length-4;items.slice(4).forEach(it=>{it.style.display='none'});const last=items[3];if(!last)return;if(!last.classList.contains('position-relative')){last.classList.add('position-relative')}
const overlay=document.createElement('div');overlay.className='more-overlay';overlay.textContent=`+${hiddenCount}`;last.appendChild(overlay)};if(window.requestAnimationFrame)requestAnimationFrame(run);else setTimeout(run,0)}
function setEditorColor(color){const editor=document.getElementById('richPostEditor');editor.style.background=color;editor.style.color=getContrastColor(color)}
function getContrastColor(hex){const rgb=hex.replace('#','').match(/.{1,2}/g).map(x=>parseInt(x,16));const brightness=(rgb[0]*299+rgb[1]*587+rgb[2]*114)/1000;return brightness>150?'#000':'#fff'}
function debounce(func,delay){let timer;return(...args)=>{clearTimeout(timer);timer=setTimeout(()=>func(...args),delay)}}
let editing=!1;let dragging=!1;let startY=0;let startPercent=0;let hasChanged=!1;document.addEventListener('click',(e)=>{const target=e.target;if(target&&target.id==='editCoverBtn'){editing=!0;const coverPreview=document.getElementById('coverPreview');const editBtn=document.getElementById('editCoverBtn');const saveBtn=document.getElementById('saveCoverBtn');const uploadBtn=document.getElementById('uploadImageBtn');editBtn&&editBtn.classList.add('d-none');saveBtn&&saveBtn.classList.remove('d-none');uploadBtn&&uploadBtn.classList.remove('d-none');if(coverPreview){coverPreview.style.cursor='grab';coverPreview.style.position='relative'}}
if(target&&target.id==='saveCoverBtn'){const coverWrapper=document.getElementById('coverWrapper');const editBtn=document.getElementById('editCoverBtn');const saveBtn=document.getElementById('saveCoverBtn');const uploadBtn=document.getElementById('uploadImageBtn');editing=!1;dragging=!1;const form=coverWrapper?.closest('form');saveBtn&&saveBtn.classList.add('d-none');uploadBtn&&uploadBtn.classList.add('d-none');editBtn&&editBtn.classList.remove('d-none')}
if(target&&target.id==='uploadImageBtn'){const coverUpload=document.getElementById('coverUpload');coverUpload&&coverUpload.click()}});document.addEventListener('change',(e)=>{const target=e.target;if(!target||target.id!=='coverUpload')return;const file=target.files&&target.files[0];if(!file)return;const coverPreview=document.getElementById('coverPreview');const offsetYInput=document.getElementById('offsetYInput');const reader=new FileReader();reader.onload=ev=>{if(coverPreview){coverPreview.src=ev.target.result;coverPreview.style.top='0px'}
if(offsetYInput)offsetYInput.value=0;hasChanged=!0};reader.readAsDataURL(file)});document.addEventListener('mousedown',(e)=>{const coverPreview=document.getElementById('coverPreview');if(!coverPreview||e.target!==coverPreview)return;if(!editing)return;dragging=!0;startY=e.clientY;const match=coverPreview.style.transform.match(/translateY\((-?\d+(?:\.\d+)?)%\)/);startPercent=match?parseFloat(match[1]):0;coverPreview.style.cursor='grabbing';e.preventDefault()});document.addEventListener('mousemove',(e)=>{if(!dragging||!editing)return;const coverPreview=document.getElementById('coverPreview');const coverWrapper=document.getElementById('coverWrapper');const offsetYInput=document.getElementById('offsetYInput');if(!coverPreview||!coverWrapper)return;const deltaY=e.clientY-startY;const imageHeight=coverPreview.clientHeight;let newPercent=startPercent+(deltaY/imageHeight)*100;const scale=coverPreview.clientWidth/coverPreview.naturalWidth;const fullImageHeight=coverPreview.naturalHeight*scale;const wrapperHeight=coverWrapper.clientHeight;const overflow=fullImageHeight-wrapperHeight;const minOffset=Math.min(0,-(overflow/fullImageHeight)*100);const maxOffset=Math.max(0,(overflow/fullImageHeight)*0);newPercent=Math.max(minOffset,Math.min(maxOffset,newPercent));coverPreview.style.transform=`translateY(${newPercent}%)`;if(offsetYInput)offsetYInput.value=newPercent;hasChanged=!0});document.addEventListener('mouseup',()=>{const coverPreview=document.getElementById('coverPreview');dragging=!1;if(editing&&coverPreview)coverPreview.style.cursor='grab'});function applyOffsetFromInput(){const offsetYInput=document.getElementById('offsetYInput');const savedPercent=parseFloat(offsetYInput?.value);if(!isNaN(savedPercent)){coverPreview.style.transform=`translateY(${savedPercent}%)`}}
window.addEventListener("resize",applyOffsetFromInput);const editBtn=document.getElementById('editCoverBtn');editBtn?.addEventListener("click",()=>{editing=!0;coverPreview.style.cursor="grab";editBtn.classList.add("d-none");saveBtn.classList.remove("d-none");uploadBtn.classList.remove("d-none")});const coverUpload=document.getElementById('coverUpload')
const uploadBtn=document.getElementById('uploadImageBtn');coverUpload?.addEventListener("change",e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=e=>{coverPreview.src=e.target.result;coverPreview.style.top="0px";offsetYInput.value=0;hasChanged=!0};reader.readAsDataURL(file)});const coverWrapper=document.getElementById('coverWrapper');const form=coverWrapper?.closest("form");form?.addEventListener("submit",e=>{if(!hasChanged){e.preventDefault();zigry.alert({title:'Info',message:"No changes to save.",type:'info'})}});let img=new Image();let ctx=null;let zoom=1;let offsetX=0;let offsetY=0;let cropDragging=!1;let cropStartX=0;let cropStartY=0;let originalProfileSrc;function initCropCanvas(){const canvas=document.getElementById('cropCanvas');if(canvas&&!ctx){ctx=canvas.getContext('2d')}
return canvas}
function openCropModal(){const el=document.getElementById('cropModal');if(!el)return;initCropCanvas();attachCanvasEvents();attachZoomEvents();try{if(window.bootstrap&&typeof window.bootstrap.Modal==='function'){const m=new window.bootstrap.Modal(el);m.show();return}}catch(_){}
el.classList.add('show');el.style.display='block';el.removeAttribute('aria-hidden');el.setAttribute('aria-modal','true');el.focus&&el.focus()}
function handleProfilePicChange(e){const file=e.target.files[0];if(!file)return;const cropCanvas=initCropCanvas();if(!cropCanvas||!ctx)return;const profilePreview=document.getElementById('profile-preview');if(profilePreview&&!originalProfileSrc){originalProfileSrc=profilePreview.src||profilePreview.style.backgroundImage?.replace(/url\(["']?|["']?\)/g,'')}
const reader=new FileReader();reader.onload=()=>{img.onload=()=>{zoom=1;offsetX=0;offsetY=0;cropCanvas.width=250;cropCanvas.height=250;const scaleX=cropCanvas.width/img.width;const scaleY=cropCanvas.height/img.height;zoom=Math.max(scaleX,scaleY);const scaledWidth=img.width*zoom;const scaledHeight=img.height*zoom;offsetX=(cropCanvas.width-scaledWidth)/2;offsetY=(cropCanvas.height-scaledHeight)/2;drawImage();openCropModal()};img.src=reader.result};reader.readAsDataURL(file)}
const profile_pic=document.getElementById('profile_pic');if(profile_pic){profile_pic.addEventListener('change',handleProfilePicChange)}
document.addEventListener('change',function(e){if(e.target&&e.target.id==='profile_pic'){handleProfilePicChange(e)}});function drawImage(){const cropCanvas=document.getElementById('cropCanvas');if(!cropCanvas||!ctx)return;const cropSize=cropCanvas.width;ctx.clearRect(0,0,cropSize,cropSize);const scaledWidth=img.width*zoom;const scaledHeight=img.height*zoom;ctx.drawImage(img,offsetX,offsetY,scaledWidth,scaledHeight);updateCrop()}
function attachCanvasEvents(){const cropCanvas=initCropCanvas();if(!cropCanvas)return;if(cropCanvas._hasEvents)return;cropCanvas._hasEvents=!0;cropCanvas.addEventListener('mousedown',(e)=>{cropDragging=!0;cropStartX=e.offsetX-offsetX;cropStartY=e.offsetY-offsetY});cropCanvas.addEventListener('mousemove',(e)=>{if(!cropDragging)return;offsetX=e.offsetX-cropStartX;offsetY=e.offsetY-cropStartY;drawImage()});cropCanvas.addEventListener('mouseup',()=>{cropDragging=!1;updateCrop()});cropCanvas.addEventListener('mouseleave',()=>cropDragging=!1)}
function attachZoomEvents(){const cropCanvas=initCropCanvas();if(!cropCanvas||cropCanvas._hasZoom)return;cropCanvas._hasZoom=!0;cropCanvas.addEventListener('wheel',(e)=>{e.preventDefault();const rect=cropCanvas.getBoundingClientRect();const canvasX=e.clientX-rect.left;const canvasY=e.clientY-rect.top;const prevZoom=zoom;const zoomFactor=0.1;if(e.deltaY<0){zoom*=(1+zoomFactor)}else{zoom*=(1-zoomFactor)}
zoom=Math.max(0.2,Math.min(5,zoom));const scaleChange=zoom/prevZoom;const imgX=canvasX-offsetX;const imgY=canvasY-offsetY;offsetX-=imgX*(scaleChange-1);offsetY-=imgY*(scaleChange-1);drawImage()},{passive:!1})}
if(document.getElementById('cropModal')){attachCanvasEvents();attachZoomEvents()}
function updateCrop(){const cropCanvas=document.getElementById('cropCanvas');if(!cropCanvas||!ctx)return;const cropped=cropCanvas.toDataURL('image/jpeg');const croppedInput=document.getElementById('cropped_image_data');if(croppedInput)croppedInput.value=cropped;const wrapper=document.getElementById("profile-preview");if(wrapper){if(wrapper.tagName==='IMG'){wrapper.src=cropped}else{wrapper.style.backgroundImage=`url(${cropped})`;wrapper.style.backgroundSize='cover';wrapper.style.backgroundPosition='center'}}
const dpupdateEl=document.getElementById('dpupdate');if(dpupdateEl){const uid=dpupdateEl.getAttribute('uid');if(uid){document.querySelectorAll('.'+uid).forEach(dpupdate)}}}
function dpupdate(el){}
function dataURItoBlob(dataURI){const byteString=atob(dataURI.split(',')[1]);const mimeString=dataURI.split(',')[0].split(':')[1].split(';')[0];const ab=new ArrayBuffer(byteString.length);const ia=new Uint8Array(ab);for(let i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}
return new Blob([ab],{type:mimeString})}
document.addEventListener('click',(e)=>{if(e.target&&e.target.id==='CropCancelBtn'){const profilePreview=document.getElementById('profile-preview');if(profilePreview&&originalProfileSrc){if(profilePreview.tagName==='IMG'){profilePreview.src=originalProfileSrc}else{profilePreview.style.backgroundImage=`url(${originalProfileSrc})`}}
zoom=1;offsetX=0;offsetY=0;originalProfileSrc=null}
if(e.target&&e.target.id==='modalSaveBtn'){document.activeElement&&document.activeElement.blur();const cropModalEl=document.getElementById('cropModal');let closed=!1;try{if(window.bootstrap&&typeof window.bootstrap.Modal==='function'){let bsModal=window.bootstrap.Modal.getInstance(cropModalEl);if(!bsModal)bsModal=new window.bootstrap.Modal(cropModalEl);bsModal.hide();closed=!0}}catch(_){}
if(!closed&&cropModalEl){cropModalEl.classList.remove('show');cropModalEl.style.display='none';cropModalEl.setAttribute('aria-hidden','true')}
const uploadForm=document.getElementById('uploadForm');const croppedData=document.getElementById('cropped_image_data');if(uploadForm&&croppedData&&croppedData.value){setTimeout(()=>{const submitEvent=new Event('submit',{bubbles:!0,cancelable:!0});uploadForm.dispatchEvent(submitEvent)},100)}else if(croppedData&&!croppedData.value){zigry.alert({title:'Warning',message:'Please crop an image first',type:'warning'})}}});let _activePreview=null;let _dragging=!1;let _startX=0;let _startScrollLeft=0;let _lastX=0;let _lastT=0;let _velocity=0;let _momentumRaf=null;document.addEventListener('mousedown',(e)=>{const preview=e.target.closest('#mediaPreview');if(!preview)return;_activePreview=preview;_dragging=!0;_startX=e.pageX-_activePreview.offsetLeft;_startScrollLeft=_activePreview.scrollLeft;_activePreview.style.cursor='grabbing';_lastX=e.pageX;_lastT=performance.now();_velocity=0;document.body.style.userSelect='none';e.preventDefault()});document.addEventListener('mouseleave',()=>{if(!_activePreview)return;endDragWithMomentum()});document.addEventListener('mouseup',()=>{if(!_activePreview)return;endDragWithMomentum()});document.addEventListener('mousemove',(e)=>{if(!_dragging||!_activePreview)return;e.preventDefault();const now=performance.now();const xAbs=e.pageX;const x=xAbs-_activePreview.offsetLeft;const walk=(x-_startX);_activePreview.scrollLeft=_startScrollLeft-walk;const dt=Math.max(1,now-_lastT);_velocity=(xAbs-_lastX)/dt;_lastX=xAbs;_lastT=now});document.addEventListener('touchstart',(e)=>{const preview=e.target.closest('#mediaPreview');if(!preview)return;_activePreview=preview;_dragging=!0;const touch=e.touches[0];_startX=touch.pageX-_activePreview.offsetLeft;_startScrollLeft=_activePreview.scrollLeft;_lastX=touch.pageX;_lastT=performance.now();_velocity=0},{passive:!0});document.addEventListener('touchmove',(e)=>{if(!_dragging||!_activePreview)return;const touch=e.touches[0];const now=performance.now();const xAbs=touch.pageX;const x=xAbs-_activePreview.offsetLeft;const walk=(x-_startX);_activePreview.scrollLeft=_startScrollLeft-walk;const dt=Math.max(1,now-_lastT);_velocity=(xAbs-_lastX)/dt;_lastX=xAbs;_lastT=now},{passive:!0});document.addEventListener('touchend',()=>{endDragWithMomentum()},{passive:!0});function endDragWithMomentum(){if(!_activePreview)return;_dragging=!1;_activePreview.style.cursor='grab';document.body.style.userSelect='';const target=_activePreview;let v=_velocity*16;const friction=0.92;cancelAnimationFrame(_momentumRaf);const step=()=>{if(Math.abs(v)<0.1){_activePreview=null;return}
target.scrollLeft-=v;v*=friction;_momentumRaf=requestAnimationFrame(step)};_momentumRaf=requestAnimationFrame(step)}
window.dataLayer=window.dataLayer||[];document.addEventListener("click",e=>{const el=e.target.closest("a, button, [data-action]");if(!el)return;dataLayer.push({event:el.dataset.action?"zig_action":"zig_click",action:el.dataset.action||null,text:(el.innerText||"").trim(),url:el.href||null,id:el.id||null,classes:el.className||null,post_id:el.closest("[data-post-id]")?.dataset.postId||null})});document.addEventListener("click",e=>{const img=e.target.closest("img");if(!img)return;dataLayer.push({event:"zig_image_click",src:img.dataset.src||img.dataset.decryptedSrc,post_id:img.closest("[data-post-id]")?.dataset.postId||null})});function trackForms(){document.querySelectorAll("form:not([data-tracked])").forEach(f=>{f.dataset.tracked=1;f.addEventListener("submit",()=>{dataLayer.push({event:"zig_form_submit",id:f.id||null,action:f.action})})})}(()=>{let fired={};window.addEventListener("scroll",()=>{let p=Math.round((scrollY/(document.body.scrollHeight-innerHeight))*100);[25,50,75,100].forEach(x=>{if(!fired[x]&&p>=x){fired[x]=1;dataLayer.push({event:"zig_scroll_depth",percent:x})}})})})();function trackPosts(){document.querySelectorAll("[data-post-id]:not([data-seen])").forEach(p=>{p.dataset.seen=1;dataLayer.push({event:"zig_post_view",post_id:p.dataset.postId})})}
if(typeof window.trackAd==="function"){const __ad=window.trackAd;window.trackAd=function(cid,type){dataLayer.push({event:"zig_ad_event",campaign_id:cid,type});return __ad.apply(this,arguments)}}
function init(){trackForms();trackPosts()}
if(window.zigry&&typeof zigry.mount==="function"){const __mount=zigry.mount;zigry.mount=function(html,props){const r=__mount.call(this,html,props);init();return r}}
document.addEventListener("DOMContentLoaded",init);class ZigrySocket{constructor(url,token){this.baseUrl=url;this.token=token;this.socket=null;this.reconnectAttempts=0;this.maxReconnectAttempts=10;this.handlers={};this.pingInterval=null;this.isManualClose=!1;this.connecting=!1;this.connect()}
connect(){if(this.connecting)return;this.connecting=!0;const token=localStorage.getItem("jwtToken")||this.token;if(token==""){this.close();return}
const wsUrl=this.baseUrl;this.socket=new WebSocket(this.baseUrl,[token]);this.socket.binaryType="arraybuffer";this.socket.onopen=()=>{this.connecting=!1;this.reconnectAttempts=0;this.startPing();if(typeof this.handlers.open==="function"){this.handlers.open()}};this.socket.onmessage=(event)=>{let data;if(event.data instanceof ArrayBuffer){const decoded=this.decode(event.data);try{data=JSON.parse(decoded)}catch(e){console.warn("Invalid JSON in binary frame",decoded);return}}else{try{data=JSON.parse(event.data)}catch(e){console.warn("Invalid JSON in text frame",event.data);return}}
if(data&&data.type&&this.handlers[data.type]){this.handlers[data.type](data)}else if(this.handlers.message){this.handlers.message(data)}};this.socket.onclose=(event)=>{this.stopPing();this.connecting=!1;if(!this.isManualClose){this.tryReconnect()}
if(typeof this.handlers.close==="function"){this.handlers.close(event)}};this.socket.onerror=(e)=>{this.connecting=!1;if(typeof this.handlers.error==="function"){this.handlers.error(e)}
if(this.socket&&this.socket.readyState!==WebSocket.CLOSING&&this.socket.readyState!==WebSocket.CLOSED){this.socket.close()}}}
startPing(){this.stopPing();this.pingInterval=setInterval(()=>{},10000)}
stopPing(){if(this.pingInterval){clearInterval(this.pingInterval);this.pingInterval=null}}
tryReconnect(){if(this.reconnectAttempts<this.maxReconnectAttempts){const delay=Math.min(30000,Math.pow(2,this.reconnectAttempts)*1000);this.reconnectAttempts++;setTimeout(()=>{this.connect()},delay)}else{if(typeof this.handlers.reconnect_failed==="function"){this.handlers.reconnect_failed()}}}
close(){this.isManualClose=!0;this.stopPing();if(this.socket){this.socket.close()}}
send(data){if(this.socket&&this.socket.readyState===WebSocket.OPEN){let encoded;if(typeof data==="object"){encoded=this.encode(JSON.stringify(data))}else{encoded=this.encode(data)}
this.socket.send(encoded)}}
encode(str){return new TextEncoder().encode(str)}
decode(buffer){return new TextDecoder().decode(buffer)}
static async encrypt(plainText,key){const iv=crypto.getRandomValues(new Uint8Array(12));const enc=new TextEncoder().encode(plainText);const cryptoKey=await this.importKey(key);const encrypted=await crypto.subtle.encrypt({name:"AES-GCM",iv},cryptoKey,enc);const combined=new Uint8Array(iv.byteLength+encrypted.byteLength);combined.set(iv,0);combined.set(new Uint8Array(encrypted),iv.byteLength);return this.base64Encode(combined)}
static async decrypt(encryptedBase64,key){const data=this.base64Decode(encryptedBase64);const iv=data.slice(0,12);const encrypted=data.slice(12);const cryptoKey=await this.importKey(key);const decrypted=await crypto.subtle.decrypt({name:"AES-GCM",iv},cryptoKey,encrypted);return new TextDecoder().decode(decrypted)}
static async importKey(keyStr){const keyData=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(keyStr));return crypto.subtle.importKey("raw",keyData,{name:"AES-GCM"},!1,["encrypt","decrypt",])}
static base64Encode(buffer){return btoa(String.fromCharCode(...buffer))}
static base64Decode(base64){const binary=atob(base64);const bytes=new Uint8Array(binary.length);for(let i=0;i<binary.length;i++){bytes[i]=binary.charCodeAt(i)}
return bytes}
to(clientId,message){this.send({type:"private",to:clientId,message})}
broadcast(message){this.send({type:"broadcast",message})}
group(roomId,message){this.send({type:"group",to:roomId,message})}
on(event,handler){this.handlers[event]=handler}};window.me=window.me||{id:"",name:"",avatar:"",groups:[]};window.me.groups=Array.isArray(window.me.groups)?window.me.groups:[];window.contacts=window.contacts||[];window.groups=window.groups||[];window.selectedContact=window.selectedContact||null;window.messages=window.messages||[];window.jwtToken=localStorage.getItem(`jwtToken${window.me.id}`)||window.jwtToken||"";const host="wss://zigry.in";const groupSeenBy={};if(window.me&&Array.isArray(window.me.groups)){window.me.groups=window.me.groups.map((id)=>Number(id))}
if(window.jwtToken){window.zigrySocket=new ZigrySocket(host,window.jwtToken)}
zigrySocket.on("private",(data)=>{let contactId=data.from==window.me.id?data.to:data.from;const contact=window.contacts.find((c)=>c.id==contactId);if(!contact)return;const msgs=loadMessages(contactId);const now=new Date();const msgObj={id:data.id,from:data.from,name:data.from==window.me.id?window.me.name:contact.name,text:data.message,time:now.toISOString(),timestamp:now.getTime(),status:data.from===window.me.id?"2":"1",};msgs.push(msgObj);saveMessages(contactId,msgs);if(window.selectedContact&&window.selectedContact.id==contactId){renderMessages(contactId);localStorage.setItem("unread_"+contactId,"0");updateContactPreview(contactId,msgObj.text,msgObj.timestamp,0);markMessagesAsSeen(contactId)}else{let unread=Number(localStorage.getItem("unread_"+contactId))||0;unread+=1;localStorage.setItem("unread_"+contactId,unread.toString());updateContactPreview(contactId,msgObj.text,msgObj.timestamp,unread)}
if(contact){contact.lastMsg=msgObj.text;contact.timestamp=msgObj.timestamp}});zigrySocket.on("notification",(data)=>{if(navigator.serviceWorker&&navigator.serviceWorker.controller){navigator.serviceWorker.controller.postMessage({type:"push",title:data.title,body:data.body,url:data.url,})}else{console.warn("No active service worker to send notification")}});zigrySocket.on("group_joined",(data)=>{if(!Array.isArray(window.me.groups)){window.me.groups=[]}
const groupId=Number(data.group);if(!window.me.groups.includes(groupId)){window.me.groups.push(groupId);renderContacts(window.groups,window.selectedContact,"group-list")}});zigrySocket.on("group_left",(data)=>{if(!Array.isArray(window.me.groups)){window.me.groups=[]}
const groupId=Number(data.group);if(!window.me.groups.includes(groupId)){window.me.groups.get(groupId).remove();renderContacts(window.groups,window.selectedContact,"group-list")}});zigrySocket.on("refresh_user",(data)=>{if(data.token&&data.token!==window.jwtToken){window.jwtToken=data.token;localStorage.setItem(`jwtToken${window.me.id}`,data.token);zigrySocket.close();zigrySocket=new ZigrySocket(host,window.jwtToken);zigrySocket.connect()}});zigrySocket.on("sent",(data)=>{updateMessageStatus(data.messageId,"2")});zigrySocket.on("delivered",(data)=>{updateMessageStatus(data.messageId,"1")});zigrySocket.on("seen",(data)=>{const contactId=data.contact;const msgs=loadMessages(contactId);let updated=!1;msgs.forEach((msg)=>{if(msg.from===window.me.id&&msg.status!=="0"){msg.status="0";updateMessageStatus(msg.id,"0");updated=!0}});if(updated){saveMessages(contactId,msgs)}});zigrySocket.on("group_seen",(data)=>{if(!groupSeenBy[data.messageId]){groupSeenBy[data.messageId]=new Set()}
groupSeenBy[data.messageId].add(data.seenBy);updateGroupMessageStatus(data.messageId)});function getStorageKey(contactId){return"chat_messages_"+contactId}
function getGroupStorageKey(groupId){return"group_messages_"+groupId}
function saveMessages(contactId,messages){localStorage.setItem(getStorageKey(contactId),JSON.stringify(messages))}
function loadMessages(contactId){try{openChat(contactId,"chat");return JSON.parse(localStorage.getItem(getStorageKey(contactId)))||[]}catch{return[]}}
function saveGroupMessages(groupId,messages){localStorage.setItem(getGroupStorageKey(groupId),JSON.stringify(messages))}
function loadGroupMessages(groupId){try{openChat(groupId,"group");return JSON.parse(localStorage.getItem(getGroupStorageKey(groupId)))||[]}catch{return[]}}
function getContactIdFromQuery(){return new URLSearchParams(window.location.search).get("contact")}
function getGroupIdFromQuery(){return new URLSearchParams(window.location.search).get("group")}
function setContactQuery(contactId){const url=new URL(window.location);url.searchParams.set("contact",contactId);url.searchParams.delete("group");window.history.replaceState({},"",url)}
function setGroupQuery(groupId){const url=new URL(window.location);url.searchParams.set("group",groupId);url.searchParams.delete("contact");window.history.replaceState({},"",url)}
async function fetchAndLoadMessages(contactId,isGroup=!1){const endpoint=isGroup?`/api/messages/group/${contactId}`:`/api/messages/contact/${contactId}`;try{const res=await fetch(endpoint,{headers:{Authorization:`Bearer ${window.jwtToken}`,},});const data=await res.json();if(Array.isArray(data)){if(isGroup){saveGroupMessages(contactId,data)}else{saveMessages(contactId,data)}}}catch(err){console.error("Failed to fetch messages:",err)}}
function isGroup(obj){return!!window.groups&&window.groups.some((g)=>g.id===obj.id)}
function timeAgo(timestamp){return humanReadableTime(timestamp)}
function setChatStatus(contact){let status="";if(contact&&contact.online){status="üü¢"}else if(contact&&contact.lastSeen){status=`(${timeAgo(contact.lastSeen)} )`}else{status=contact?.status||""}
document.getElementById("chatStatus").innerText=status}
let filtered=window.contacts;let filteredGroup=window.groups;document.getElementById("searchInput")?.addEventListener("input",function(e){const search=e.target.value.trim().toLowerCase();filtered=window.contacts.filter((c)=>c.name.toLowerCase().includes(search));filteredGroup=window.groups.filter((g)=>g.name.toLowerCase().includes(search));renderContacts(filtered,window.selectedContact,"contact-list");renderContacts(filteredGroup,window.selectedContact,"group-list")});function renderContacts(contacts,selectedContact,listId="contact-list"){const el=document.getElementById(listId);if(!el)return;el.innerHTML="";contacts.forEach((c)=>{const isGroupContact=listId=="group-list";const isMember=isGroupContact?(window.me.groups||[]).includes(Number(c.id)):!0;const unread=Number(localStorage.getItem("unread_"+c.id))||0;const lastMsg=c.lastMsg||"Say hi!";const key=isGroupContact?c.groupkey:c.msgkeyenc;const onlineStatus=!isGroupContact?(c.online?"üü¢":"üî¥"):"";const timeVal=c.online?"":c.timestamp?timeAgo(c.timestamp):"";const li=document.createElement("li");li.className=`contact-item d-flex py-2 align-items-start border-top border-opacity-25 justify-content-between ${
      selectedContact &&
      Number(selectedContact.id || selectedContact) === Number(c.id)
        ? "active"
        : ""
    }`;li.setAttribute("data-id",c.id);li.style.cursor="pointer";const avatarDiv=document.createElement("div");avatarDiv.className="me-3 flex-shrink-0";avatarDiv.innerHTML=`<img src="${
      c.avatar || "/default-group.png"
    }" alts="${
      c.name
    }" class="avatar rounded-circle" style="width:50px; height:50px; object-fit:cover;">`;const centerDiv=document.createElement("div");centerDiv.className="flex-grow-1 d-flex flex-column";const topRow=document.createElement("div");topRow.className="align-items-center";const nameSpan=document.createElement("span");nameSpan.className="fw-bold text-truncate";nameSpan.textContent=c.name;topRow.appendChild(nameSpan);const statusSpan=document.createElement("span");statusSpan.className="smallest mx-1";statusSpan.innerHTML=onlineStatus;topRow.appendChild(statusSpan);centerDiv.appendChild(topRow);const msgDiv=document.createElement("div");msgDiv.className="text-truncate small text-white-50 my-1 contact-last-msg";msgDiv.style.minWidth="90px";const bottomRow=document.createElement("div");bottomRow.className="d-flex align-items-center justify-content-between flex-wrap";const btnContainer=document.createElement("div");btnContainer.className="btn-group";if(isGroupContact){if(!isMember){const joinBtn=document.createElement("button");joinBtn.className="btn btn-outline-primary btn-sm mt-2 p-0";joinBtn.textContent="Join";joinBtn.setAttribute("data-id",c.id);joinBtn.onclick=(e)=>{e.stopPropagation();zigry.confirm("Join this group to start chatting?").then((result)=>{if(result===!0){joinGroup(c.id)}})};btnContainer.appendChild(joinBtn)}else{const leaveBtn=document.createElement("button");leaveBtn.className="btn btn-outline-danger btn-sm float-end p-0 mt-2";leaveBtn.textContent="Leave";leaveBtn.setAttribute("data-id",c.id);leaveBtn.onclick=(e)=>{e.stopPropagation();zigry.confirm("Leave this group?").then((result)=>{if(result===!0){leaveGroup(c.id)}})};btnContainer.appendChild(leaveBtn);centerDiv.appendChild(msgDiv);ZigrySocket.decrypt(lastMsg,key).then((decryptedText)=>{msgDiv.textContent=decryptedText}).catch(()=>{msgDiv.textContent=lastMsg})}}else{ZigrySocket.decrypt(lastMsg,key).then((decryptedText)=>{msgDiv.textContent=decryptedText}).catch(()=>{msgDiv.textContent=lastMsg});centerDiv.appendChild(msgDiv)}
bottomRow.appendChild(btnContainer);centerDiv.appendChild(bottomRow);const rightDiv=document.createElement("div");rightDiv.className="flex-shrink-0 ms-3 d-flex align-items-center";if(unread>0&&!isGroupContact){const unreadBadge=document.createElement("span");unreadBadge.className="badge rounded-pill bg-primary";unreadBadge.textContent=unread;rightDiv.appendChild(unreadBadge)}
li.appendChild(avatarDiv);li.appendChild(centerDiv);li.appendChild(rightDiv);li.onclick=()=>{if(isGroupContact&&!isMember){zigry.confirm("Join this group to start chatting?").then((result)=>{if(result===!0){joinGroup(c.id)}})}else{selectContactOrGroup(c,isGroupContact,!0)}};el.appendChild(li)})}
function selectContactOrGroup(obj,isGroupContact,updateQuery=!1){window.selectedContact=obj;document.querySelectorAll(".contact-item").forEach((li)=>li.classList.remove("active"));const li=document.querySelector(`.contact-item[data-id="${obj.id}"]`);if(li)li.classList.add("active");document.getElementById("chatTitle").innerText=obj.name;var chatTitle=document.getElementById("chatTitle");if(isGroupContact&&filteredGroup){renderGroupMessages(obj.id);showGroupLeaveButton(obj.id);renderContacts(filteredGroup,window.selectedContact,"group-list");if(updateQuery)setGroupQuery(obj.id);}else{setChatStatus(obj);renderMessages(obj.id);hideGroupLeaveButton();renderContacts(filtered,window.selectedContact,"contact-list");if(updateQuery)setContactQuery(obj.id);}
markMessagesAsSeen(obj.id);if(!isGroupContact&&!obj.online&&!obj.lastSeen){zigrySocket.send({type:"get_last_seen",userId:obj.id})}
localStorage.setItem("unread_"+obj.id,"0");if(li){const badge=li.querySelector(".unread");if(badge)badge.remove();}
updateChatInputVisibility()}
function showGroupLeaveButton(groupId){let leaveBtn=document.getElementById("group-leave-btn");if(!leaveBtn){leaveBtn=document.createElement("button");leaveBtn.id="group-leave-btn";leaveBtn.className="btn btn-outline-danger btn-sm ms-3 float-end";leaveBtn.innerText="Leave";leaveBtn.setAttribute("data-id",groupId);leaveBtn.onclick=function(){zigry.confirm("Leave this group?").then((result)=>{if(result===!0){leaveGroup(groupId)}})};document.getElementById("chatTitle").parentNode.appendChild(leaveBtn)}else{leaveBtn.onclick=function(){zigry.confirm("Leave this group?").then((result)=>{if(result===!0){leaveGroup(groupId)}})};leaveBtn.style.display=""}}
function hideGroupLeaveButton(){let leaveBtn=document.getElementById("group-leave-btn");if(leaveBtn)leaveBtn.style.display="none"}
async function renderMessages(contactId,scrollToBottom=!0,scrollToPosition=null){const el=document.getElementById("chat-messages");const contact=window.contacts.find((c)=>c.id==contactId);const msgs=loadMessages(contactId);el.innerHTML="";msgs.forEach((msg)=>{const isSelf=msg.from==window.me.id;let statusIcon=isSelf?getMessageStatusIcon(msg):"";const row=document.createElement("div");row.className="d-flex mb-3 "+(isSelf?"flex-row-reverse":"");row.setAttribute("data-id",msg.id);const readableDate=msg.timestamp?timeAgo(msg.timestamp):"";const bubble=document.createElement("div");bubble.className=`chat-bubble ${isSelf ? "self" : ""}`;bubble.innerText="Decrypting...";const msgWrapper=document.createElement("div");msgWrapper.appendChild(bubble);const meta=document.createElement("div");meta.className="d-flex justify-content-between align-items-center mt-1";meta.style="font-size: 0.75rem; color: #666;";meta.innerHTML=`
            <div class="msg-status-container text-end" style="flex:1;">${
              isSelf ? statusIcon : ""
            }</div>
            <span class="date ms-2" style="white-space: nowrap;">${readableDate}</span>
        `;msgWrapper.appendChild(meta);row.innerHTML=`
            <img class="message-avatar me-2 ms-2" src="${
              isSelf
                ? window.me.avatar
                : window.selectedContact?.avatar || "/default.png"
            }" alts="avatar">
        `;row.appendChild(msgWrapper);el.appendChild(row);const key=isSelf?window.selectedContact.msgkeyenc:window.selectedContact.msgkeydec;ZigrySocket.decrypt(msg.text,key).then((decryptedText)=>{bubble.innerText=decryptedText}).catch(()=>{bubble.innerText=msg.text})});if(scrollToPosition!==null){requestAnimationFrame(()=>{el.scrollTop=scrollToPosition})}else if(scrollToBottom){requestAnimationFrame(()=>{el.scrollTop=el.scrollHeight})}}
function renderGroupMessages(groupId,scrollToBottom=!0,scrollToPosition=null){const el=document.getElementById("chat-messages");const group=window.groups.find((g)=>g.id==groupId);const groupkey=group.groupkey;const msgs=loadGroupMessages(groupId);el.innerHTML="";msgs.forEach((msg)=>{const isSelf=msg.from==window.me.id;let seenList=groupSeenBy[msg.id]?Array.from(groupSeenBy[msg.id]):[];let statusText=seenList.length?`üó®Ô∏è Seen by ${seenList.length}`:"‚úì";let statusIcon=isSelf?`<span class="msg-status text-muted" data-status="${statusText}">${statusText}</span>`:"";const readableDate=msg.timestamp?timeAgo(msg.timestamp):"";const row=document.createElement("div");row.className="d-flex mb-3 "+(isSelf?"flex-row-reverse":"");row.innerHTML=`
            <img class="message-avatar me-2 ms-2" src="${
              isSelf ? window.me.avatar : group.avatar || "/default-group.png"
            }" alts="avatar">
            <div>
                <div class="chat-bubble ${isSelf ? "self" : ""}">
                    <div class="message-meta small ${
                      isSelf ? "text-end" : ""
                    } mb-1">
                        ${
                          !isSelf
                            ? `<span class="fw-bold me-2">${msg.name}</span>`
                            : ""
                        }
                    </div>
                    <span class="encrypted-text">Decrypting...</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-1" style="font-size: 0.75rem; color: #666;">
                    <span class="date ms-2" style="white-space: nowrap;">${readableDate}</span>
                    <div class="msg-status-container ${
                      isSelf ? "text-end ml-2" : ""
                    }" style="flex:1;">${statusIcon}</div>
                </div>
            </div>
        `;el.appendChild(row);const textSpan=row.querySelector(".encrypted-text");ZigrySocket.decrypt(msg.text,groupkey).then((decryptedText)=>{textSpan.innerText=decryptedText}).catch(()=>{textSpan.innerText="[Encrypted]"})});requestAnimationFrame(()=>{if(scrollToPosition!==null)el.scrollTop=scrollToPosition;else if(scrollToBottom)el.scrollTop=el.scrollHeight})}
function getMessageStatusIcon(msg){if(msg.from!==window.me.id)return"";const status=String(msg.status||"2");if(status==="0")
return `<span class="msg-status text-info" title="Seen" data-status="0">‚úì‚úì</span>`;if(status==="1")
return `<span class="msg-status text-primary" title="Delivered" data-status="1">‚úì‚úì</span>`;if(status==="2")
return `<span class="msg-status text-secondary" title="Sent" data-status="2">‚úì</span>`;if(status==="3"){return `<span class="msg-status text-danger" title="Failed to send" data-status="3" style="cursor:pointer;" onclick="retryMessage('${msg.id}')">‚òí</span>`}
return `<span class="msg-status text-danger" title="Unknown" data-status="99">?</span>`}
function retryMessage(messageId){const contactId=window.selectedContact?.id;const msgs=loadMessages(contactId);const msg=msgs.find((m)=>m.id===messageId);if(!msg)return;zigrySocket.send(contactId,{type:"private",to:contactId,message:msg.text,id:messageId,});msg.status="2";saveMessages(contactId,msgs);renderMessages(contactId)}
function updateMessageStatus(messageId,newStatus){const contactId=window.selectedContact?.id;if(!contactId)return;const msgs=loadMessages(contactId);const msg=msgs.find((m)=>m.id===messageId);if(msg){const priority={0:3,1:2,2:1,3:0};const current=msg.status||"2";if(priority[newStatus]>priority[current]){msg.status=newStatus;saveMessages(contactId,msgs)}}
let retries=5;const tryUpdate=()=>{const msgEl=document.querySelector(`[data-id="${messageId}"]`);if(!msgEl){if(retries-->0)return setTimeout(tryUpdate,100);console.warn("Message DOM not found:",messageId);return}
const container=msgEl.querySelector(".msg-status-container");if(!container)return;const newIcon=getMessageStatusIcon({from:window.me.id,status:newStatus,});container.innerHTML=newIcon};tryUpdate()}
function markMessagesAsSeen(contactId){const msgs=loadMessages(contactId);const unseen=msgs.filter((m)=>m.from!==window.me.id&&m.status!=="0");if(unseen.length>0&&window.zigrySocket){zigrySocket.send({type:"seen",contact:contactId,});unseen.forEach((m)=>(m.status="0"));saveMessages(contactId,msgs);if(window.selectedContact&&window.selectedContact.id===contactId){renderMessages(contactId)}}}
if(document.getElementById("chat-form")){document.getElementById("chat-form").onsubmit=function(e){e.preventDefault();const input=document.getElementById("chat-input");const text=input.value.trim();if(!text||!window.selectedContact)return;const isGroupChat=isGroup(window.selectedContact);const enckey=isGroupChat?window.selectedContact.groupkey:window.selectedContact.msgkeyenc;ZigrySocket.encrypt(text,enckey).then((encryptedText)=>{const now=Date.now();const msgObj={id:`${window.me.id}-${now}`,from:window.me.id,name:window.me.name,text:encryptedText,timestamp:now,status:"",};if(isGroupChat){const groupId=window.selectedContact.id;if(!window.me.groups.includes(groupId)){alert("You must join this group to chat.");return}
zigrySocket.send({type:"group",to:groupId,message:encryptedText,});const msgs=loadGroupMessages(groupId);msgs.push(msgObj);saveGroupMessages(groupId,msgs);renderGroupMessages(groupId);input.value=""}else{zigrySocket.send({type:"private",to:window.selectedContact.id,message:encryptedText,id:msgObj.id,});const contactId=window.selectedContact.id;const msgs=loadMessages(contactId);msgs.push(msgObj);saveMessages(contactId,msgs);renderMessages(contactId);updateContactPreview(contactId,text,now);const contact=window.contacts.find((c)=>c.id==contactId);if(contact){contact.lastMsg=text;contact.timestamp=now}
input.value=""}})}}
zigrySocket.on("online_users",(data)=>{if(Array.isArray(data.userIds)){window.contacts.forEach((c)=>{c.online=data.userIds.includes(String(c.id))});renderContacts(filtered,window.selectedContact,"contact-list")}});zigrySocket.on("user_online",(data)=>{const contact=window.contacts.find((c)=>String(c.id)===String(data.userId));if(contact){contact.online=!0;renderContacts(filtered,window.selectedContact,"contact-list")}});zigrySocket.on("user_offline",(data)=>{const contact=window.contacts.find((c)=>String(c.id)===String(data.userId));if(contact){contact.online=!1;renderContacts(filtered,window.selectedContact,"contact-list")}});zigrySocket.on("last_seen",(data)=>{const contact=window.contacts.find((c)=>String(c.id)===String(data.userId));if(contact){contact.online=!1;contact.lastSeen=data.lastSeen;renderContacts(filtered,window.selectedContact,"contact-list");if(window.selectedContact&&window.selectedContact.id==contact.id){setChatStatus(contact)}}});function joinGroup(groupId){zigrySocket.send({type:"join_group",group:groupId})}
function leaveGroup(groupId){zigrySocket.send({type:"leave_group",group:groupId})}(async function initialSelectFromQuery(){const contactQueryId=getContactIdFromQuery();const groupQueryId=getGroupIdFromQuery();let obj=null;let isGroupContact=!1;if(groupQueryId){obj=window.groups.find((g)=>g.id===groupQueryId)||null;document.getElementById("tab-group")?.click();isGroupContact=!0}else if(contactQueryId){obj=window.contacts.find((c)=>c.id===contactQueryId)||null}
renderContacts(window.contacts,!isGroupContact?obj:null,"contact-list");renderContacts(window.groups,isGroupContact?obj:null,"group-list");if(obj){await fetchAndLoadMessages(obj.id,isGroupContact);selectContactOrGroup(obj,isGroupContact,!1)}else{window.selectedContact=null;updateChatInputVisibility()}})();document.getElementById("tab-direct")?.onclick(function(){document.getElementById("tab-direct").classList.add("active");document.getElementById("tab-group").classList.remove("active");document.getElementById("contact-list").classList.remove("d-none");document.getElementById("group-list").classList.add("d-none")});document.getElementById("tab-group")?.onclick(function(){document.getElementById("tab-group").classList.add("active");document.getElementById("tab-direct").classList.remove("active");document.getElementById("contact-list").classList.add("d-none");document.getElementById("group-list").classList.remove("d-none")});function updateChatInputVisibility(){const chatInputContainer=document.getElementById("chat-input-container");const chatMessages=document.getElementById("chat-messages");if(!chatInputContainer)return;if(!window.selectedContact){if(chatInputContainer.style.display)
chatInputContainer.style.display="none";if(chatMessages.innerHTML)
chatMessages.innerHTML='<div class="text-center text-muted p-5">Select a contact or group to start chat</div>'}else{chatInputContainer.style.display=""}}
zigrySocket.onopen=function(){zigrySocket.send({type:"get_online_users"});zigrySocket.send({type:"get_friends"});(window.me.groups||[]).forEach((groupId)=>{joinGroup(groupId)})};function updateContactPreview(contactId,lastMsg,time,unread=null){const li=document.querySelector(`.contact-item[data-id="${contactId}"]`);if(!li)return;const lastMsgDiv=li.querySelector(".contact-last-msg");const lastTimeDiv=li.querySelector(".date");if(lastMsgDiv)lastMsgDiv.textContent=lastMsg;if(lastTimeDiv){lastTimeDiv.textContent=timeAgo(time)}
let badge=li.querySelector(".unread");if(unread===null)
unread=Number(localStorage.getItem("unread_"+contactId))||0;if(unread>0){if(!badge){badge=document.createElement("span");badge.className="unread badge rounded-pill bg-primary mt-1";lastTimeDiv?.parentNode.appendChild(badge)}
badge.textContent=unread}else if(badge){badge.remove()}}
function openChat(chatId,type){const isMobile=window.innerWidth<768;const url=new URL(window.location);history.replaceState({},"",url);if(isMobile){document.getElementById("chatList").classList.remove("d-block");document.getElementById("chatList").classList.add("d-none");document.getElementById("messageBox").classList.remove("d-none");document.getElementById("messageBox").classList.add("d-block")}}
function backToChatList(){const url=new URL(window.location);const c=getContactIdFromQuery();if(c){url.searchParams.delete("contact")}else{url.searchParams.delete("group")}
window.history.replaceState({},"",url);const isMobile=window.innerWidth<768;if(isMobile){document.getElementById("messageBox").classList.remove("d-block");document.getElementById("messageBox").classList.add("d-none");document.getElementById("chatList").classList.remove("d-none");document.getElementById("chatList").classList.add("d-block")}}